---
output: 
  pdf_document:
    
    
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
geometry: margin=2.54cm
title: "Temporal, Spatial, and Regression Analyses of Lead Air Pollution Patterns and Sources in Pennsylvania"
subtitle: "https://github.com/nyb5208/Alcorn_Bao_Hermanson_ENV_872_EDA_FinalProject.git"
author: "Jack Alcorn, Max Hermanson, and Nancy Bao "
fontsize: 12pt
mainfont: Times New Roman
editor_options:
  chunk_output_type: console
---

\newpage
\tableofcontents 
\newpage
\listoftables
\newpage
\listoffigures 
\newpage

```{r setup, include=FALSE}
# Set your working directory
getwd()
# Load your packages
library(tidyverse)
library(ggplot2)
library(ggridges)
library(ggpubr)
library(dplyr)
library(lubridate)
library(zoo)
library(trend)
library(sf)
library(Kendall)
library(knitr)
library(kableExtra)
#Load color palette packages
library(RColorBrewer)
library(wesanderson)
library(viridisLite)
library(viridis)
library(colormap)
library(mapview)
library(sf)
# Set your ggplot theme
project.theme <- theme_classic(base_size=12)+
                 theme(plot.title= 
                         element_text(size=14,
                         face="bold",
                         color= "black",
                         hjust=0.5),
                         axis.text = 
                         element_text(color = "black"),
                         axis.title = 
                         element_text(color= "black",face= "bold"),
                         legend.position="top")
theme_set(project.theme)
#___________________

# Load EPA Air Lead Pollution datasets
epa.PAlead.2010 <-read.csv( "./Data/Raw/EPA_Lead_PA/EPA_10_PA_lead.csv", stringsAsFactors = TRUE)
epa.PAlead.2011 <-read.csv( "./Data/Raw/EPA_Lead_PA/EPA_11_PA_lead.csv", stringsAsFactors = TRUE)
epa.PAlead.2012 <-read.csv( "./Data/Raw/EPA_Lead_PA/EPA_12_PA_lead.csv", stringsAsFactors = TRUE)
epa.PAlead.2013 <-read.csv( "./Data/Raw/EPA_Lead_PA/EPA_13_PA_lead.csv", stringsAsFactors = TRUE)
epa.PAlead.2014 <-read.csv( "./Data/Raw/EPA_Lead_PA/EPA_14_PA_lead.csv", stringsAsFactors = TRUE)
epa.PAlead.2015 <-read.csv( "./Data/Raw/EPA_Lead_PA/EPA_15_PA_lead.csv", stringsAsFactors = TRUE)
epa.PAlead.2016 <-read.csv( "./Data/Raw/EPA_Lead_PA/EPA_16_PA_lead.csv", stringsAsFactors = TRUE)
epa.PAlead.2017 <-read.csv( "./Data/Raw/EPA_Lead_PA/EPA_17_PA_lead.csv", stringsAsFactors = TRUE)
epa.PAlead.2018 <-read.csv( "./Data/Raw/EPA_Lead_PA/EPA_18_PA_lead.csv", stringsAsFactors = TRUE)
epa.PAlead.2019 <-read.csv( "./Data/Raw/EPA_Lead_PA/EPA_19_PA_lead.csv", stringsAsFactors = TRUE)
epa.PAlead.2020 <-read.csv( "./Data/Raw/EPA_Lead_PA/EPA_20_PA_lead.csv", stringsAsFactors = TRUE)
# Combined the EPA lead air data sets with rbind()
epa.PAair.lead <-rbind(epa.PAlead.2010, epa.PAlead.2011, epa.PAlead.2012, epa.PAlead.2013,
                       epa.PAlead.2014, epa.PAlead.2015, epa.PAlead.2016, epa.PAlead.2017,
                       epa.PAlead.2018, epa.PAlead.2019, epa.PAlead.2020)

#Change date variable from factor to date
epa.PAair.lead$Date <- as.Date(epa.PAair.lead$Date, format="%m/%d/%Y")
class(epa.PAair.lead$Date)
```
# Introduction
Lead is a heavy metal that is naturally found in the Earth’s crust and commonly used in many human products and industries (WHO, 2019). However, its ubiquitous use has caused extensive environmental contamination and public health concerns in many parts of the world (Ab Latif Wani and Usmani, 2015). Main sources of lead contamination include mining, smelting, manufacturing, recycling activities, leaded paint, leaded gasoline, and leaded aviation fuel (US EPA, 2021a). Over three quarters of global lead consumption is for the manufacturing of lead-acid batteries for motor vehicles (WHO, 2019). 

Once ingested, lead spreads through the blood into other parts of the body.  Depending on the level of exposure, lead can adversely affect the nervous system, kidney function, immune system, reproductive and developmental systems and the cardiovascular system (US EPA, 2020a).  One of the biggest health concerns of lead consumption is the neurological effects on children. Children are particularly sensitive to lead exposure and can have side effects such as behavioral problems, learning disabilities, and lower IQ (Ab Latif Wani and Usmani, 2015). 

Currently, the National Ambient Air Quality Standards (NAAQS) for lead are 0.15 micrograms per cubic meter Pb in total suspended particles as a 3-month average (US EPA, 2021b). Air quality monitors are placed throughout the United States in order to measure air lead levels. In our project, we look at lead air quality monitors in the state of Pennsylvania from 2010 to 2020.

# Rationale
In this study, we were interested in evaluating lead air pollution in Pennsylvania. In the 2019 United Health Foundation’s annual American Health Rankings report, Pennsylvania was rated 47th in the United States for air quality (United Health Foundation, 2019). The metropolitan areas around major Pennsylvania cities such as Pittsburgh, Philadelphia, and Lancaster are currently ranked among the top 25 most polluted in the country (American Lung Association, 2021). Pennsylvania’s pollution history is embedded in various industries such as agriculture, manufacturing steel production, and coal mining and smelting (Stevens, 1955). The latter two have contributed to the current sources of lead pollution in the air, soil, and water around the state (O’Shea et al., 2020). 

Other historical uses of lead in paints, gasoline, water pipes, and  batteries fueled the lead smelting industries in the state, especially in major cities like Philadelphia (O’Shea et al., 2020). From a 2014 report from the Pennsylvania  Department of Health, approximately 70% of homes in Pennsylvania were built prior to the leaded paint ban in 1978 (PA Department of Health, 2014); this has become a major source of human lead exposure as homes begin aging and the leaded paint chips deposit into the soil (O’Shea et al., 2020; PA Department of Health, 2014). Current industrial emissions (e.g. from smelters, airports, metal processing facilities, incinerators) and lead from historical uses are now found in soils and roadside dust that get resuspended into the ambient air (US EPA, 2021a). Humans can be exposed to lead via inhalation of resuspended dust and soil particles containing lead in the air. Humans may also be exposed via ingestion of lead-contaminated water, food, and dust (Pizzol and Andersen, 2010). 

Considering Pennsylvania’s industrial and historical uses of lead as well as its current air quality status, we were interested in current air lead pollution levels and lead exposure levels in Pennsylvania. We decided to look at more recent temporal trends of air lead levels of the EPA criteria pollutant, and chose a ten-year period from 2010 to 2020. Furthermore, we were interested in identifying how air lead levels were spatially associated with socioeconomic factors including income and poverty at the county level. As lead is an EPA criteria pollutant, we were also interested in exploring how sources of air lead (e.g. frequency of metal processing plants, airports, incinerators) may be associated with lead exposure in children in Pennsylvania. These analyses are summarized in the following research questions: 

##Research Questions:

1. ***How do air lead levels vary from 2010 to 2020 across the major metropolitan areas in Pennsylvania?***

2. ***What are the spatial associations between air lead levels and socioeconomic factors (ie. income and poverty) across counties in Pennsylvania?***

3. ***Is lead exposure (measured via blood lead levels) in children in Pennsylvania associated with air lead emission sources?***

\newpage

# Dataset Information

## CDC Childhood Blood Lead Surveillance Data: Blood Lead Levels (µg/dL) among Children < 72 Months of Age, by County and Blood Lead Level (BLL) Group, 2017 (.csv)
>The CDC has a national surveillance system for assessing blood lead levels (BLL). Data is collected from health-care provider reports to the CDC on a variety of metrics, which include number of patients with BLL greater than 5 µg/dL, and the average BLL of counties. The CDC notes these data may be biased by the fact that those who are tested for elevated BLL are typically tested because they predisposed to higher levels due to certain criteria. 

## Federal Aviation Administration Airport Data (shapefile)
>These data are collected by the FAA through legally-required reporting by existing airports. This dataset is updated regularly, and the data used in our research project was from April, 2021. Notable attributes included for each airport were geographic coordinates, status active, airport purpose, and type of aircraft used at the airport. 

## Pennsylvania Department of Environmental Protection (DEP) Database on Mineral Preparation Plants and Incinerators (shapefile)
>A mineral preparation plant is a site at which extracted minerals are processed in order to separate and purify elements and compounds of interest. These processes typically require heating the minerals to very high temperatures, which can release lead particulates into the air. The DEP keeps track of the location, owner, site status, and primary facility type of these plants. Data used in this study were dated to April of 2021. 

>Detailed and regular incinerator data is also maintained by the DEP (last updated in April 2021). Incinerators combust waste products, which emits particulate matter whose composition depends upon the type of waste being burned. Incinerators are used for a variety of materials, including garbage, industrial scrap products, hospital waste, and dead organisms or cadavers. Filters were applied to select only industrial-waste-related incinerators that might possess lead particulates. 

## US Census Metropolitan and Micropolitan Statistical Area Population Estimates and Estimated Components of Change: April 1, 2010 to July 1, 2019 
>Metropolitan and Micropolitan Statistical Area Population Estimates and Estimated Components of Change were collected by the US Census in 2019 across the United States. Estimates for total population size, numeric change in total population, births, deaths, natural increase periods defined by births minus deaths, net domestic migration, net international migration, net migration periods, and residuals from 2011 to 2019 were based on population size data from the 2010 US Census (US Census Bureau, 2020a). The dataset also contains the population size reported in the 2010 US Census as the variable, CENSUS2010POP. The following dataset contained the following identifier variables for the metropolitan and micropolitan statistical areas in the United States: name of the statistical area (NAME), the 5-digit core statistical based area (CBSA) code, and the legal statistical area description (LSAD) (US Census Bureau, 2020b). For this study, only the following variables were used: CBSA, NAME, LSAD, and CENSUS2010POP.

## US EPA Daily Air Lead Data 2010-2020 
The daily air lead levels data were collected from all outdoor monitoring sites from the US EPA Air Quality System Data Mart. Data for each year were individually downloaded from the US EPA Outdoor Air Quality Database. The daily air lead levels were taken from 24-hr average lead level observations measured in ug/m^3 and recorded by the air quality System (AQS) (About Air Data Reports, 2021). The data included the following variables: date of air lead measurement, source of data, the daily mean lead concentration ug/m^3, daily observation count, and data completion percentage, based on the site monitoring frequency and schedule (About Air Data Reports, 2021). 

The following site identifier variables were also included in the datasets: parameter occurrence code (POC), which specifies the monitor number that collected the data, 5-digit AQS parameter code, site name, 2-digit state federal information processing system (FIPS) code, state name, the 3-digit county FIPS code, county name, site ID (composed of the state FIPs code, county FIPS code, and 4-character AQS code), core statistical based area (CBSA) name and code for the metropolitan area designated to the monitoring site, and the site latitude and longitude coordinates (About Air Data Reports, 2021). 

## CDC Social Vulnerability Data (2010 and 2018)

Social Vulnerability data was collected over five year time periods in the state of Pennsylvania using the American Community Survey. For the 2010 data, data was collected from 2006-2010 and the 2018 data was collected from the years 2014-2018. Questions involved in the survey covered vulnerability topics such as socioeconomic status, household composition and disability, minority status and language, and housing type and transportation. The data set included  over one hundred variables. The variables used in the following analysis include county name, per capita income (E_PCI), and percentage of persons below poverty estimate (EP_POV). 
\newpage
# Methods
## Question 1: How do air lead levels vary from 2010 to 2020 across the major metropolitan areas in Pennsylvania?
### Data Wrangling
US EPA daily mean air lead concentration data for each year from 2010 to 2020 were individually read into RStudio as separate dataframes and combined into one dataframe for all daily mean air lead levels from 2010 to 2020, using the rbind() function. The combined data frame was further processed with a pipe that selected for the date lead levels were collected, the monitoring site ID, the site name, the CBSA name and code identifiers, state name, county name and county FIPS code; a new variable for month, year, and date formatted as month-year were created using the mutate() function. 

Air lead levels from 2010 to 2020 were assessed across Pennsylvania by metropolitan statistical areas. The top five most populous metropolitan areas were the focus of this portion of the study. The reason is that these areas were assumed to have historically higher industrial emissions and more sources of lead associated with legacy paint and gasoline, and sources from aviation fuel from airports (US EPA, 2020a). Furthermore, the Air Quality System only collected lead concentration measurements for 15 counties in Pennsylvania across this period, and so we were limited to analyses at the metropolitan area level  rather than at the county level. 

US Census data for  Metropolitan and Micropolitan Statistical Area Population Estimates and Estimated Components of Change: April 1, 2010 to July 1, 2019 were read in as a dataframe and processed with a pipeline that selected for metropolitan area data by the 5-digit CBSA code, names of the metropolitan areas that overlapped with the US EPA daily mean lead concentration dataset, as well as the 2010 US Census reported population size. The top five metropolitan areas by population size (1= most populous)  in Pennsylvania were identified as (1) Philadelphia-Camden-Wilmington, PA-NJ-DE-MD, (2)Pittsburgh, PA, (3)Allentown-Bethlehem-Easton, PA-NJ, (4)Scranton--Wilkes-Barre--Hazleton, PA, (5)Lancaster, PA. 

The processed, combined 2010-2020 US EPA daily mean air lead concentrations dataframe were filtered by the unique CBSA codes for each metropolitan area and individual data frames were created for each metropolitan area which contained their respective date and lead concentration measurements. 


### Exploratory Analysis 
A new variable was created using the mutate() function to summarize and calculate the monthly mean air lead levels for each metropolitan area dataframe. Monthly mean air lead levels for all metropolitan areas were calculated from 2010 to 2020. Line plots were generated for the monthly mean air lead levels for each metropolitan area to assess the trends in air lead levels between 2010 to 2020.  The monthly air lead levels were graphed in three-month intervals in each metropolitan area and were compared to the primary and secondary EPA 3-month rolling average NAAQS for lead, 0.15ug/m^3. 

### Data Analysis 
The daily mean air lead data for each metropolitan area data frame contained missing air lead concentration measurements for certain days and a linear interpolation was applied to the daily mean air lead levels for each metropolitan area. Spline interpolations were not used as data did not follow a quadratic or higher-order polynomial trend. Linear interpolation was used over piecewise interpolation because our study was interested in the change in air lead levels over a continuous ten-year period of time from 2010 to 2020. The linearly interpolated daily mean air lead levels for each metropolitan area were combined into one dataframe. Following linear interpolation of the daily mean air lead levels for each metropolitan area dataframe, the data frames were converted into time series objects for daily observations and monthly observations. Seasonality was not observed for the interpolated daily mean air lead levels for the metropolitan areas. Nonseasonal Mann-Kendall trend tests were conducted on the daily and monthly time series objects for mean air lead levels for each of the five metropolitan areas. 


## Question 2: What are the spatial associations between air lead levels and socioeconomic factors (ie. income and poverty) across counties in Pennsylvania?
### Data Wrangling
Data wrangling began with grouping EPA air lead concentration data by county, latitude and longitude for the years of 2010, 2015, and 2020 using the group_by() function. County mean and maximum lead concentrations for 2010, 2015, and 2020 were computed by averaging all county daily mean lead concentrations and selecting the maximum county daily mean lead concentration through the summarize () function. These data sets were then converted into spatial features st_as_sf () function and using NAD 83 as a coordinate reference system. EPA mean and maximum air lead concentration values were then joined with a Pennsylvania county shape file, county per capita income estimates and percentage of people in poverty estimates using the left_join () function. These data frames were joined by the county column. We also looked at lead concentrations that exceeded air quality standards of .15 micrograms per cubic meter for 2010, 2015, and 2020. To obtain max lead concentrations over .15 micrograms per cubic meter, values that exceeded this limit in the EPA air lead concentration were filtered out of the EPA air lead concentration data using the filter() function. 

### Exploratory Analysis 
Data exploration used graphs to visually analyze lead concentration for 2010, 2015 and 2020. Different data visualization techniques were experimented with to determine what best represented the data and made the graphs visually appealing. Mean population for each county was also considered as a variable for spatial associations of high lead concentrations but this did not prove to be useful when graphed. This variable was taken out of the analysis. 

### Data Analysis 
Analysis consisted of overlaying per capita income and percentage of people in poverty estimates on top of mean and max air lead concentration values. In the end, maps were created for lead concentration levels paired with either per capita income or percentage of persons below poverty for all years. These were visually compared to each other to determine trends in the past to years and if the variables used showed spatial association. Maps were also created for the max lead concentration levels that were above .15 micrograms per cubic meter. These were used to analyze differences between all three years. 

## Question 3: Is lead exposure (measured via blood lead levels) in children in Pennsylvania associated with air lead emission sources?
### Data Wrangling
1. Matching coordinates with counties
Shape files for specific metal processing plants, incinerators, and airports were individually read as separate dataframes and converted to ‘sf’ dataframes within R, and the ‘st_intersects’ function was used in conjunction with U.S. 2010 census data to identify in which county each of these features were located. 

Specific types of metal processing plants, incinerators, and airports were filtered out using the filter() function for a variety of criteria specified in the Dataset Description section of this document. 

2. Combining datasets into one (converted column classes, renamed columns)
It was important to compile attribute information for each county into a single dataframe so that a regression could be run upon each county observation. In order to combine separate dataframes for the aforementioned shapefiles, class differences and syntax differences between the columns and their values were resolved. Common changes that had to occur were getting rid of leading zeros (001 vs. 1) and renaming the county code columns for each attribute to “COUNTYFP10” (later on, Jack’s county per capita income and county poverty sf dataframes were merged into this dataframe to include more variables into the model). 

3. Cleaning and prepping data
Data was cleaned and prepped for transformations: replaced NA’s with zeros for the plant/airport data and added small integer values to all data in order to log transform variables with values of zero. 

### Exploratory Analysis 
1. Examined distribution of variables and transformed where necessary
The variables’ distributions were examined, and individual scatter plots for each explanatory variable (EV) were created against the response variables to check for linearity. Based on these results, the metal processing plant data (METAL) and incinerator data (INCINERATE) were logged, and the county poverty data (POV) were squared to be a quadratic term. Residuals v Fitted graphs of these showed better fits. 
### Data Analysis 
2. Tested assumptions 
An ordinary least squares (OLS) multilinear regression was carried out. The following assumptions were tested for: linearity, homoscedasticity, multicollinearity, and normality. 

Based on the residuals vs fitted plot, the final model is non-linear. It possesses an upward-cone shape and the red trend line sharply trails off at higher fitted values. 
The final model appears to be heteroskedastic based on its scale-location graph, which sharply deviates from zero at higher fitted values. This model does not meet the homoskedasticity assumption. 
Multicollinearity was examined using the vif() function, which conducts a Variance Inflation Factor between explanatory variables. Values above two are considered moderately correlated, but given how close two most of them were, mean-centering was not performed. 
This model met the normality assumption based on the Normal Q-Q plot. 
\newpage
# 
```{r exploratory-analysis, include= FALSE, warning = FALSE,message=FALSE}
#
#Cleaned and Processed EPA PA Air Lead Data
epa.PA.airPb.processed <- epa.PAair.lead %>%
                                  select(Date, Site.ID, 
                                         Daily.Mean.Pb.Concentration,
                                         Site.Name,AQS_PARAMETER_DESC,CBSA_NAME,CBSA_CODE,
                                         STATE,COUNTY, COUNTY_CODE) %>%
                                  mutate(Month = month(Date),
                                  Year=year(Date)) %>%
                                  mutate(Date_combined = my(paste0(Month,"-",Year)))
##### Looking at air lead level averages by metropolitan area 
#####
epa.PA.air.Pb.summary.msa <-epa.PAair.lead %>%
  select(Date, CBSA_NAME, CBSA_CODE, Daily.Mean.Pb.Concentration)%>%
  group_by(CBSA_NAME) %>%
  dplyr::summarise(Mean.monthly.Pb = mean(Daily.Mean.Pb.Concentration))
epa.PA.air.Pb.summary.msa
```
\newpage

# Results 
## Question 1: How do air lead levels vary from 2010 to 2020 across the major metropolitan areas in Pennsylvania?
From the lineplot of the linearly interpolated daily mean air lead levels for the five metropolitan areas, we see that mean daily lead levels appear to be decreasing from 2010 to 2020. It is important to note that the time intervals vary between the metropolitan areas for mean daily air lead measurements. Mean daily air lead levels were measured from 2010 to 2020 for the Pittsburgh, PA and the Philadelphia-Camden-Wilmington, PA-NJ-DE-MD metropolitan areas. Mean daily air lead levels were measured from 2012 to 2020 for the Lancaster, PA and the Allentown-Bethlehem-Easton, PA-NJ metropolitan areas. The mean daily air lead levels were measured from 2010 to 2018 for the Scranton--Wilkes-Barre--Hazleton, PA metropolitan areas.

To further assess the trends, the non-seasonal Mann-Kendall trend tests for the daily time series objects found that four of the five most populous metropolitan followed significant, monotonic trends for daily and monthly mean air lead levels. The Mann-Kendall trend test for the daily time series found significant (p<0.05) downward monotonic trends for mean daily air lead levels the following metropolitan areas:  Philadelphia-Camden-Wilmington, PA-NJ-DE-MD (tau = -0.168, p-value=< 2.22e-16), Pittsburgh, PA (tau = -0.276, p-value=< 2.22e-16), Allentown-Bethlehem-Easton, PA-NJ (tau= -0.257 , p-value=< 2.22e-16 ), Scranton--Wilkes-Barre--Hazleton, PA (tau=-0.53, , p-value=< 2.22e-16). Lancaster, PA had a downward, non-monotonic trend (p>0.05) for daily mean air lead levels (tau=-0.0181, p-value =0.145). The nonseasonal Mann-Kendall trend tests for the monthly time series objects found significant (p<0.05) downward monotonic trends for the following metropolitan areas: Philadelphia-Camden-Wilmington, PA-NJ-DE-MD (tau=-0.711 , p-value<2.22e-16 ), Pittsburgh, PA (tau=-0.755, p-value<2.22e-16 ), Allentown-Bethlehem-Easton, PA-NJ (tau= -0.378 , p-value= 1.78e-08 ), and Scranton--Wilkes-Barre--Hazleton, PA (tau=-0.593 , p-value<2.22e-16 ). There was a non-monotonic (p-value>0.05) downward trend observed for monthly mean air lead levels in Lancaster, PA (tau= -0.0055, p-value = 0.934).


```{r time_series-data-wrangling,echo=FALSE}
#Looking at the lead air concentrations for major metropolitan areas in Pennsylvania 
# Looking at the Combined Statistical Areas (CBSA) to identify the metropolitan areas included in this study
summary(epa.PA.airPb.processed$CBSA_NAME)
summary(as.factor(epa.PA.airPb.processed$CBSA_CODE))
#associated CBSA codes 
### Allentown-Bethlehem-Easton, PA-NJ =10900
### Chambersburg-Waynesboro =16540
### Erie=21500
### Indiana=26860
### Lancaster=29540
### Lewisburg=30260
### New Castle=35260
### Reading=39740
### Pittsburgh =38300
### Philadelphia-Camden-Wilmington, PA-NJ-DE-MD =39780
### Reading=39740
summary(epa.PA.airPb.processed$COUNTY)

#Need to determine the top 5 metropolitan areas by 2010 US Census population size (most populated):
## Loaded US census data to determine the most populated metropolitan areas from the CBSAs provided in the epa Air Lead data
PA.msa.population.size <-read.csv("./Data/Raw/PA_Metro_Area_data/cbsa-est2019-alldata.csv")
#Set CBSA variable as factor
as.factor(PA.msa.population.size$CBSA)
### Process the PA.msa.population.size data so I only have PA metro areas filtered by CBSA code
PA.msa.pop.processed <- PA.msa.population.size %>%
                          filter(LSAD=="Metropolitan Statistical Area") %>%
                          select(CBSA, NAME, CENSUS2010POP) %>%
                          filter(CBSA %in% c("10900", "16540", "21500", "26860", "29540",
                                        "30260", "35260", "37980",
                                        "38300", "39740", "42540"))%>%
                          arrange(desc(CENSUS2010POP))
#Picked the Top 5 Metropolitan Areas to look at based on 2010 US Census Population Size:
## 1. Philadelphia-Camden-Wilmington, PA-NJ-DE-MD 
## 2. Pittsburgh, PA  
## 3. Allentown-Bethlehem-Easton, PA-NJ 
## 4. Scranton--Wilkes-Barre--Hazleton, PA
## 5. Lancaster, PA 
#Looked at Monthly Lead Air concentrations of the Five major metropolitan areas in Pennsylvania 
#Philadelphia-Camden-Wilmington, PA-NJ-DE-MD 
epa.PA.monthly.Pb.Philly <-epa.PA.airPb.processed %>%
                  filter(CBSA_CODE==37980)%>%
                  select(Date,Date_combined, Daily.Mean.Pb.Concentration,) %>%
                  group_by(Date_combined)%>%
                  dplyr::summarise(Mean.monthly.Pb = mean(Daily.Mean.Pb.Concentration))%>%
                  add_column(CBSA="Philadelphia-Camden-Wilmington")
epa.PA.monthly.Pb.Philly
#
#Pittsburgh Metropolitan Area
epa.PA.monthly.Pb.Pitt <-epa.PA.airPb.processed %>%
                  filter(CBSA_CODE==38300)%>%
                  select(Date,Date_combined, Daily.Mean.Pb.Concentration,) %>%
                  group_by(Date_combined)%>%
                  dplyr::summarise(Mean.monthly.Pb = mean(Daily.Mean.Pb.Concentration))%>%
                  add_column(CBSA="Pittsburgh")
epa.PA.monthly.Pb.Pitt
#only have data from 2010 to 2017 for Pittsburgh area (Allegheny Co., PA)
#
# Allentown-Bethlehem-Easton, PA-NJ Metropolitan Area
epa.PA.monthly.Pb.Allentown <-epa.PA.airPb.processed %>%
                  filter(CBSA_CODE==10900)%>%
                  select(Date,Date_combined, Daily.Mean.Pb.Concentration,) %>%
                  group_by(Date_combined)%>%
                  dplyr::summarise(Mean.monthly.Pb = mean(Daily.Mean.Pb.Concentration))%>%
                  add_column(CBSA="Allentown-Bethlehem-Easton")
epa.PA.monthly.Pb.Allentown 
#Now looking at major mining county: Scranton-Wilkes-Barre-Hazleton Metropolitan Area (Luzerne Co, PA)
epa.PA.monthly.Pb.Scranton <-epa.PA.airPb.processed %>%
                  filter(CBSA_CODE==42540)%>%
                  select(Date,Date_combined,COUNTY, Daily.Mean.Pb.Concentration,) %>%
                  group_by(Date_combined)%>%
                  dplyr::summarise(Mean.monthly.Pb = mean(Daily.Mean.Pb.Concentration))%>%
                  add_column(CBSA="Scranton-Wilkes_Barre-Hazleton")
epa.PA.monthly.Pb.Scranton 
# Lancaster Metropolitan Area 
epa.PA.monthly.Pb.Lancaster <-epa.PA.airPb.processed %>%
                  filter(CBSA_CODE==29540)%>%
                  select(Date,Date_combined,COUNTY, Daily.Mean.Pb.Concentration,) %>%
                  group_by(Date_combined)%>%
                  dplyr::summarise(Mean.monthly.Pb = mean(Daily.Mean.Pb.Concentration))%>%
                  add_column(CBSA="Lancaster")
epa.PA.monthly.Pb.Lancaster
#Created a monthly mean Pb air concentration in PA counties 
Pa.monthly.Pb.MSA<-rbind(epa.PA.monthly.Pb.Philly, epa.PA.monthly.Pb.Pitt, epa.PA.monthly.Pb.Allentown, epa.PA.monthly.Pb.Scranton, epa.PA.monthly.Pb.Lancaster)
Pa.monthly.Pb.MSA
class(Pa.monthly.Pb.MSA$Date_combined)
```


```{r time-series-visuals,echo=false,fig.align='left',fig.cap="Monthly Average Pb Air Concentrations from 2010 to 2020 in PA Metro Areas",fig.height = 8, fig.width = 10}
#Looking at the top 5 Metropolitan Areas for air Pb concentrations from 2010 to 2020 
#PA Metropolitan Area
PAmonthly_plot<-ggplot(Pa.monthly.Pb.MSA,aes(x = Date_combined,
                      y = Mean.monthly.Pb, color= CBSA))+
                      geom_line() +
                      labs(y="Monthly Average Pb Air Concentration (ug/m^3)",
                           x="Date")+
                          scale_x_date(date_breaks = "3 months",date_labels = "%b %Y",
                                       limits=c(as.Date("2010-01-01"), as.Date("2021-01-01")),
             expand=c(0,0))+
                          theme(axis.text.x=element_text(angle=90, hjust=1))+
                      geom_hline(yintercept=0.15, linetype='dotted', col = 'black')+
                      annotate("text", x = as.Date("2016-12-01", "%Y-%m-%d"), y = 0.15,
                               label = "EPA Primary and Secondary 3-month Average Pb NAAQ Standard=0.15ug/m^3", vjust = -0.5)
print(PAmonthly_plot)

```

```{r linear_interpolation,include=FALSE}
# Philadelphia-Camden-Wilmington, PA-NJ-DE-MD 
Philadelphia.days <-as.data.frame(seq(ymd("2010-01-02"), ymd("2020-12-29"),by="days"))
Philadelphia.days <-setNames(Philadelphia.days,c("Date"))
Phila.msa.Pb.filter <-epa.PA.airPb.processed %>%
                        filter(CBSA_CODE==37980) %>%
                        select(Date,Daily.Mean.Pb.Concentration)
Phila.msa.Pb<-left_join(Philadelphia.days,Phila.msa.Pb.filter)
Phila.msa.Pb.cleaned <-Phila.msa.Pb %>%
                        mutate(Daily.Mean.Pb.Concentration.clean=
                                 zoo::na.approx(Daily.Mean.Pb.Concentration)) %>%
                        add_column(MSA=c("Philadelphia-Camden-Wilmington, PA-NJ-DE-MD"))                        
# Pittsburgh, PA 
Pitt.days <-as.data.frame(seq(ymd("2010-01-02"), ymd("2020-12-29"),by="days"))
Pitt.days <-setNames(Pitt.days, c("Date"))
Pitt.msa.Pb.filter<-epa.PA.airPb.processed %>%
                        filter(CBSA_CODE==38300) %>%
                        select(Date,Daily.Mean.Pb.Concentration)
Pitt.msa.Pb<-left_join(Pitt.days,Pitt.msa.Pb.filter)
Pitt.msa.Pb.cleaned <- Pitt.msa.Pb %>%
                        mutate(Daily.Mean.Pb.Concentration.clean=
                                 zoo::na.approx(Daily.Mean.Pb.Concentration)) %>%
                        add_column(MSA=c("Pittsburgh, PA"))
# Allentown-Bethlehem-Easton, PA-NJ 
Allentown.days <-as.data.frame(seq(ymd("2012-07-02"), ymd("2020-12-29"),by="days"))
Allentown.days<-setNames(Allentown.days,c("Date"))
Allentown.msa.Pb.filter<-epa.PA.airPb.processed %>%
                   filter(CBSA_CODE==10900)%>%
                   select(Date,Daily.Mean.Pb.Concentration)
Allentown.msa.Pb<-left_join(Allentown.days,Allentown.msa.Pb.filter)
#Cleaned Allentown data
Allentown.msa.Pb.cleaned <-Allentown.msa.Pb %>%
  mutate(Daily.Mean.Pb.Concentration.clean=
           zoo::na.approx(Daily.Mean.Pb.Concentration))%>%
           add_column(MSA=c("Allentown-Bethlehem-Easton, PA-NJ"))
Allentown.msa.Pb.cleaned
#
# Scranton--Wilkes-Barre--Hazleton, PA
Scranton.days <-as.data.frame(seq(ymd("2010-01-02"), ymd("2018-09-29"),by="days"))
Scranton.days <-setNames(Scranton.days,c("Date"))
Scranton.msa.Pb.filter<-epa.PA.airPb.processed %>%
                          filter(CBSA_CODE==42540)%>%
                          select(Date,Daily.Mean.Pb.Concentration)
Scranton.msa.Pb<-left_join(Scranton.days,Scranton.msa.Pb.filter)
#Cleaned Scranton data
Scranton.msa.Pb.cleaned <-Scranton.msa.Pb %>%
  mutate(Daily.Mean.Pb.Concentration.clean=
           zoo::na.approx(Daily.Mean.Pb.Concentration)) %>%
           add_column(MSA=c("Scranton--Wilkes-Barre--Hazleton, PA"))
Scranton.msa.Pb.cleaned
#
#Lancaster, PA
Lancaster.days <-as.data.frame(seq(ymd("2012-01-04"), ymd("2020-12-29"),by="days"))
Lancaster.msa.Pb.filter<- epa.PA.airPb.processed %>%
                          filter(CBSA_CODE=="29540") %>%
                          select(Date,Daily.Mean.Pb.Concentration)

Lancaster.days<-setNames(Lancaster.days,c("Date"))
#
Lancaster.msa.Pb <-left_join(Lancaster.days,Lancaster.msa.Pb.filter)
Lancaster.msa.Pb.cleaned <-Lancaster.msa.Pb %>%
  mutate(Daily.Mean.Pb.Concentration.clean=
           zoo::na.approx(Daily.Mean.Pb.Concentration))%>%
           add_column(MSA=c("Lancaster, PA"))
```

```{r linear-interp-visual,echo=FALSE, fig.align='left',fig.cap="Daily average air Pb levels from 2010 to 2020 in the five most populous metropolitan areas in PA",fig.height = 8, fig.width = 10}
#first I joined all the linear interpolated data together
PA.msa.Pb.cleaned <-rbind(Phila.msa.Pb.cleaned,Pitt.msa.Pb.cleaned,Allentown.msa.Pb.cleaned,Scranton.msa.Pb.cleaned, Lancaster.msa.Pb.cleaned)
class(PA.msa.Pb.cleaned$Date)
#
PA.msa.Pb.cleaned.plot<-ggplot(PA.msa.Pb.cleaned, aes(x = Date,
                      y = Daily.Mean.Pb.Concentration.clean, color= MSA))+
                      geom_line() +
                      labs(y="Daily Average Air Pb Level (ug/m^3)",
                           x="Date",
                          title="",
                          color="")+
                          scale_x_date(date_breaks = "3 months",date_labels = "%b %Y",
                                       limits=c(as.Date("2010-01-01"), as.Date("2021-01-01")),
             expand=c(0,0))+
                          theme(axis.text.x=element_text(angle=90, hjust=1))+
                      geom_hline(yintercept=0.15, linetype='dotted', col = 'black')+
                      annotate("text", x = as.Date("2016-12-01", "%Y-%m-%d"), y = 0.15,
                               label = "EPA Primary and Secondary 3-month Average Pb NAAQ Standard=0.15ug/m^3", vjust = -0.5)
print(PA.msa.Pb.cleaned.plot)

```

```{r time-series-analysis, include=FALSE}
#I am looking at the  metropolitan areas with Air Pb Levels that exceeded the EPA primary and secondary NAAQs
#Pittsburgh
Pitt.msa.linear.interp.plot <-ggplot(Pitt.msa.Pb.cleaned)+
geom_line(aes(x = Date,
y = Daily.Mean.Pb.Concentration.clean),
color = "chartreuse4", alpha=0.5) +
labs(y="Daily Mean Air Pb Level (ug/m^3)",title="Daily Mean Air Pb Levels in the Pittsburgh, PA Metropolitan Area from 2010 to 2020")+
  scale_x_date(date_breaks = "3 months",date_labels = "%b %Y",
                                       limits=c(as.Date("2010-01-01"), as.Date("2020-01-01")),
             expand=c(0,0))+
                      geom_hline(yintercept=0.15, linetype='dotted', col = 'black')+
                      annotate("text", x = as.Date("2016-12-01", "%Y-%m-%d"), y = 0.15,
                               label = "EPA Primary and Secondary 3-month Average Pb NAAQ Standard=0.15ug/m^3", vjust = -0.5)+
                          theme(axis.text.x=element_text(angle=90, hjust=1))+
  theme(plot.margin=unit(c(1,1,1.5,1.2),"cm"))
print(Pitt.msa.linear.interp.plot)
#
Pitt.monthly.Pb.msa <-Pitt.msa.Pb.cleaned %>%
                        mutate(Month = month(Date),
                        Year=year(Date)) %>%
                        mutate(Date_combined = my(paste0(Month,"-",Year)))%>%
                        group_by(Date_combined)%>%
                        dplyr::summarise(Mean.monthly.Pb=mean(Daily.Mean.Pb.Concentration.clean))
Pitt.monthly.Pb.msa <- Pitt.monthly.Pb.msa %>%
                           mutate(Date=as.Date(Date_combined))
#Checking the first and last dates of data collection
first(Pitt.msa.Pb.cleaned$Date)
last(Pitt.msa.Pb.cleaned$Date)
#
#Time Series: daily
Pitt.msa.Pb.daily.ts <-ts(Pitt.msa.Pb.cleaned$Daily.Mean.Pb.Concentration.clean,
                              start=c(2010,1),
                              end=c(2020,12),
                              frequency=365)
#Time Series: monthly
Pitt.msa.Pb.monthly.ts <-ts(Pitt.monthly.Pb.msa$Mean.monthly.Pb,
                                start=c(2010,1),
                                end=c(2020,12),
                                frequency=12)
#
Pitt.msa.Pb.daily.decomp <- stl(Pitt.msa.Pb.daily.ts, s.window = "periodic")
plot(Pitt.msa.Pb.daily.decomp)

Pitt.msa.Pb.monthly.decomp <-stl(Pitt.msa.Pb.monthly.ts, s.window = "periodic")
plot(Pitt.msa.Pb.monthly.decomp)
#
Pitt.Pb.daily.trend.nonseasonal <-Kendall::MannKendall(Pitt.msa.Pb.daily.ts)
summary(Pitt.Pb.daily.trend.nonseasonal)
#
Pitt.Pb.monthly.trend.nonseasonal <-Kendall::MannKendall(Pitt.msa.Pb.monthly.ts)
summary(Pitt.Pb.monthly.trend.nonseasonal)
#Scranton-Wilkes-Barre-Hazleton
#Scranton linear interpolation
Scranton.msa.linear.interpolation<-ggplot(Scranton.msa.Pb.cleaned) +
geom_line(aes(x = Date,
y = Daily.Mean.Pb.Concentration.clean),
color = "blue", alpha=0.5) +
labs(y="Daily Mean Pb Air Concentration (ug/m^3)",title="Daily Mean Air Pb Levels in the Scranton-Wilkes-Barre-Hazleton Metropolitan Area from 2010 to 2018")+
  scale_x_date(date_breaks = "3 months",date_labels = "%b %Y",
                                       limits=c(as.Date("2010-01-01"), as.Date("2018-10-01")),
             expand=c(0,0))+
                      geom_hline(yintercept=0.15, linetype='dotted', col = 'black')+
                      annotate("text", x = as.Date("2014-10-01", "%Y-%m-%d"), y = 0.15,
                               label = "EPA Primary and Secondary 3-month Average Pb NAAQ Standard=0.15ug/m^3", vjust = -0.5)+
                          theme(axis.text.x=element_text(angle=90, hjust=1))+
  theme(plot.margin=unit(c(1,1,1.5,1.2),"cm"))
print(Scranton.msa.linear.interpolation)
#
Scranton.monthly.Pb.msa <-Scranton.msa.Pb.cleaned %>%
                        mutate(Month = month(Date),
                        Year=year(Date)) %>%
                        mutate(Date_combined = my(paste0(Month,"-",Year)))%>%
                        group_by(Date_combined)%>%
                        dplyr::summarise(Mean.monthly.Pb=mean(Daily.Mean.Pb.Concentration.clean))
Scranton.monthly.Pb.msa <- Scranton.monthly.Pb.msa %>%
                           mutate(Date=as.Date(Date_combined))
#Checking the first and last dates of data collection
first(Scranton.msa.Pb.cleaned$Date)
last(Scranton.msa.Pb.cleaned$Date)
#
#Time Series: daily
Scranton.msa.Pb.daily.ts <-ts(Scranton.msa.Pb.cleaned$Daily.Mean.Pb.Concentration.clean,
                              start=c(2010,1),
                              end=c(2018,9),
                              frequency=365)
#Time Series: monthly
Scranton.msa.Pb.monthly.ts <-ts(Scranton.monthly.Pb.msa$Mean.monthly.Pb,
                                start=c(2010,1),
                                end=c(2018,9),
                                frequency=12)
#
Scranton.msa.Pb.daily.decomp <- stl(Scranton.msa.Pb.daily.ts, s.window = "periodic")
plot(Scranton.msa.Pb.daily.decomp)

Scranton.msa.Pb.monthly.decomp <-stl(Scranton.msa.Pb.monthly.ts, s.window = "periodic")
plot(Scranton.msa.Pb.monthly.decomp)
#
Scranton.Pb.daily.trend.nonseasonal <-Kendall::MannKendall(Scranton.msa.Pb.daily.ts)
summary(Scranton.Pb.daily.trend.nonseasonal)
#
Scranton.Pb.monthly.trend.nonseasonal <-Kendall::MannKendall(Scranton.msa.Pb.monthly.ts)
summary(Scranton.Pb.monthly.trend.nonseasonal)
#Lancaster, PA
#Lancaster linear interpolation
Lancaster.msa.linear.interpolation<-ggplot(Lancaster.msa.Pb.cleaned) +
geom_line(aes(x = Date,
y = Daily.Mean.Pb.Concentration.clean),
color = "orange", alpha=1)
labs(y="Daily Mean Air Pb Level (ug/m^3)",title="Daily Mean Air Pb Levels in the Lancaster, PA Metropolitan Area from 2012 to 2020")+
  scale_x_date(date_breaks = "3 months",date_labels = "%b %Y",
                                       limits=c(as.Date("2012-01-01"), as.Date("2021-01-01")),
             expand=c(0,0))+
                      geom_hline(yintercept=0.15, linetype='dotted', col = 'black')+
                      annotate("text", x = as.Date("2014-10-01", "%Y-%m-%d"), y = 0.15,
                               label = "EPA Primary and Secondary 3-month Average Pb NAAQ Standard=0.15ug/m^3", vjust = -0.5)+
                          theme(axis.text.x=element_text(angle=90, hjust=1))+
  theme(plot.margin=unit(c(1,1,1.5,1.2),"cm"))
print(Lancaster.msa.linear.interpolation)
#
Lancaster.monthly.Pb.msa <-Lancaster.msa.Pb.cleaned %>%
                        mutate(Month = month(Date),
                        Year=year(Date)) %>%
                        mutate(Date_combined = my(paste0(Month,"-",Year)))%>%
                        group_by(Date_combined)%>%
                        dplyr::summarise(Mean.monthly.Pb=mean(Daily.Mean.Pb.Concentration.clean))
Lancaster.monthly.Pb.msa <- Lancaster.monthly.Pb.msa %>%
                           mutate(Date=as.Date(Date_combined))
#Checking the first and last dates of data collection
first(Lancaster.msa.Pb.cleaned$Date)
last(Lancaster.msa.Pb.cleaned$Date)
#
#Time Series: daily
Lancaster.msa.Pb.daily.ts <-ts(Lancaster.msa.Pb.cleaned$Daily.Mean.Pb.Concentration.clean,
                              start=c(2012,1),
                              end=c(2020,12),
                              frequency=365)
#Time Series: monthly
Lancaster.msa.Pb.monthly.ts <-ts(Lancaster.monthly.Pb.msa$Mean.monthly.Pb,
                                start=c(2012,1),
                                end=c(2020,12),
                                frequency=12)
#
Lancaster.msa.Pb.daily.decomp <- stl(Lancaster.msa.Pb.daily.ts, s.window = "periodic")
plot(Lancaster.msa.Pb.daily.decomp)

Lancaster.msa.Pb.monthly.decomp <-stl(Lancaster.msa.Pb.monthly.ts, s.window = "periodic")
plot(Lancaster.msa.Pb.monthly.decomp)
#
Lancaster.Pb.daily.trend.nonseasonal <-Kendall::MannKendall(Lancaster.msa.Pb.daily.ts)
summary(Lancaster.Pb.daily.trend.nonseasonal)
#
Lancaster.Pb.monthly.trend.nonseasonal <-Kendall::MannKendall(Lancaster.msa.Pb.monthly.ts)
summary(Lancaster.Pb.monthly.trend.nonseasonal)

#Allentown
Allentown.msa.linear.interpolation<-ggplot(Allentown.msa.Pb.cleaned) +
geom_line(aes(x = Date,
y = Daily.Mean.Pb.Concentration.clean),
color = "aquamarine", alpha=1) +
labs(y="Daily Mean Air Pb Level (ug/m^3)",title="Daily Mean Air Pb Levels in the Allentown-Bethlehem-Easton, PA-NJ Metropolitan Area from 2012 to 2020")+
  scale_x_date(date_breaks = "3 months",date_labels = "%b %Y",
                                       limits=c(as.Date("2012-07-01"), as.Date("2021-01-01")),
             expand=c(0,0))+
                      geom_hline(yintercept=0.15, linetype='dotted', col = 'black')+
                      annotate("text", x = as.Date("2014-10-01", "%Y-%m-%d"), y = 0.15,
                               label = "EPA Primary and Secondary 3-month Average Pb NAAQ Standard=0.15ug/m^3", vjust = -0.5)+
                          theme(axis.text.x=element_text(angle=90, hjust=1))+
  theme(plot.margin=unit(c(1,1,1.5,1.2),"cm"))
print(Allentown.msa.linear.interpolation)
#Checking the first and last dates of data collection
first(Allentown.msa.Pb.cleaned$Date)
last(Allentown.msa.Pb.cleaned$Date)
#
Allentown.monthly.Pb.msa <-Allentown.msa.Pb.cleaned %>%
                        mutate(Month = month(Date),
                        Year=year(Date)) %>%
                        mutate(Date_combined = my(paste0(Month,"-",Year)))%>%
                        group_by(Date_combined)%>%
                        dplyr::summarise(Mean.monthly.Pb=mean(Daily.Mean.Pb.Concentration.clean))
Allentown.monthly.Pb.msa <- Allentown.monthly.Pb.msa %>%
                           mutate(Date=as.Date(Date_combined))
#Time Series: daily
Allentown.msa.Pb.daily.ts <-ts(Allentown.msa.Pb.cleaned$Daily.Mean.Pb.Concentration.clean,
                              start=c(2012,7),
                              end=c(2020,12),
                              frequency=365)
Allentown.Pb.daily.trend.nonseasonal <-Kendall::MannKendall(Allentown.msa.Pb.daily.ts)
summary(Allentown.Pb.daily.trend.nonseasonal)
#Time Series: monthly
Allentown.msa.Pb.monthly.ts <-ts(Allentown.monthly.Pb.msa$Mean.monthly.Pb,
                                start=c(2012,7),
                                end=c(2020,12),
                                frequency=12)
Allentown.Pb.monthly.trend.nonseasonal <- Kendall::MannKendall(Allentown.msa.Pb.monthly.ts)
summary(Allentown.Pb.monthly.trend.nonseasonal)
#Decomposition of the time series
Allentown.msa.Pb.daily.decomp <- stl(Allentown.msa.Pb.daily.ts, s.window = "periodic")
plot(Allentown.msa.Pb.daily.decomp)
#
Allentown.msa.Pb.monthly.decomp <- stl(Allentown.msa.Pb.monthly.ts, s.window = "periodic")
plot(Allentown.msa.Pb.monthly.decomp)
#Decided to look at Philadelphia as well
#Checking the first and last dates of data collection
first(Phila.msa.Pb.cleaned$Date)
last(Phila.msa.Pb.cleaned$Date)
#
Phila.monthly.Pb.msa <-Phila.msa.Pb.cleaned %>%
                        mutate(Month = month(Date),
                        Year=year(Date)) %>%
                        mutate(Date_combined = my(paste0(Month,"-",Year)))%>%
                        group_by(Date_combined)%>%
                        dplyr::summarise(Mean.monthly.Pb=mean(Daily.Mean.Pb.Concentration.clean))
Phila.monthly.Pb.msa <- Phila.monthly.Pb.msa %>%
                           mutate(Date=as.Date(Date_combined))
#Time Series: daily
Phila.msa.Pb.daily.ts <-ts(Phila.msa.Pb.cleaned$Daily.Mean.Pb.Concentration.clean,
                              start=c(2010,1),
                              end=c(2020,12),
                              frequency=365)
Phila.Pb.daily.trend.nonseasonal <-Kendall::MannKendall(Phila.msa.Pb.daily.ts)
summary(Phila.Pb.daily.trend.nonseasonal)
#Time Series: monthly
Phila.msa.Pb.monthly.ts <-ts(Phila.monthly.Pb.msa$Mean.monthly.Pb,
                                start=c(2010,1),
                                end=c(2020,12),
                                frequency=12)
Phila.Pb.monthly.trend.nonseasonal <- Kendall::MannKendall(Phila.msa.Pb.monthly.ts)
summary(Phila.Pb.monthly.trend.nonseasonal)
#Decomposition of the time series
Phila.msa.Pb.daily.decomp <- stl(Phila.msa.Pb.daily.ts, s.window = "periodic")
plot(Phila.msa.Pb.daily.decomp)
#
Phila.msa.Pb.monthly.decomp <- stl(Phila.msa.Pb.monthly.ts, s.window = "periodic")
plot(Phila.msa.Pb.monthly.decomp)
```

## Question 2: What are the spatial associations between air lead levels and socioeconomic factors (ie. income and poverty) across counties in Pennsylvania?
The spatial analysis confirmed that mean lead concentration levels have gone down from 2010 to 2020. The highest mean concentration levels for 2010 was .15 /mug/m^3 compared to .1 /mug/m^3 for 2015 and .03 /mug/m^3 for 2020. The graphs also showed where high lead concentrations resided in the state of Pennsylvania. Counties that had the highest concentrations were Lancaster, Berks, Lehigh, Beaver, Allegheny, and Indiana. These are areas that have medium levels of people below poverty and tend to have lower per capita income levels compared with the rest of the state. When looking at the amount of maximum lead concentration levels that were above the air quality standard of .15 /mug/m^3, 2010 had 7 locations that exceeded this limit. Berks and Beaver each had two areas with readings above .9 /mug/m^3. For 2015 and 2020, there were only three locations (for each year) that exceeded the air quality standard limit. Beaver county had zero areas during these years and Berks county reduced to only one reading at approximately .24 /mug/m^3. This spatial analysis assists with the time series analysis done in the section above. Moving forward, doing an analysis at a smaller scale would provide improved results. Future analysis could look at counties, such as Berks and Beaver, and perform analysis at the zip code level. 

```{r spatial-analysis 2010, echo=FALSE, fig.cap="2010 Mean Lead Levels Across Pennsylvania",fig.align='left',fig.height = 8, fig.width = 10}
#Reduce our data to just one record for each location, computing mean and max daily values 

EPAair_PA_Lead_avg2010 <- epa.PAlead.2010 %>%
  group_by(COUNTY, SITE_LATITUDE, SITE_LONGITUDE) %>%
  summarize(meanPb = mean(Daily.Mean.Pb.Concentration),
            maxPb = max(Daily.Mean.Pb.Concentration))



#Convert the dataset to a spatially enabled "sf" data frame
sf_PA_Lead_avg2010 <- st_as_sf(EPAair_PA_Lead_avg2010,
                             coords = c('SITE_LONGITUDE','SITE_LATITUDE'),
                             crs=4326)

sf_PA_Lead_high_2010<-filter(sf_PA_Lead_avg2010, maxPb > 0.15)
range(sf_PA_Lead_high_2010$meanPb)



#read in county shape file
counties_sf<- st_read('./Data/Spatial/cb_2018_us_county_20m.shp')%>%
  filter(STATEFP == 42) #Filter for just PA Counties
colnames(counties_sf)[2]<-"CNTY_FIPS"
colnames(counties_sf)[6]<-"COUNTY"

counties_sf$CNTY_FIPS<-as.numeric(counties_sf$CNTY_FIPS)


#read in CDC Data for each year and group by county
#2010
CDC_PA_2010<-read.csv("./Data/Raw/Pennsylvania_CDC_2010.csv", header = TRUE)

CDC_PA_2010$CNTY_FIPS<-as.numeric(CDC_PA_2010$CNTY_FIPS)

CDC_PA_2010_avg<-CDC_PA_2010%>%
  group_by(CNTY_FIPS) %>%
  summarize(meanPCI = mean(E_PCI),
            meanPOV = mean(E_P_POV),
            meanPOP = sum(TOTPOP))

range(CDC_PA_2010_avg$meanPCI)

#join CDC data and county shape file
PA_county_2010<-left_join(counties_sf, CDC_PA_2010_avg, by = c("CNTY_FIPS"))


ggplot() + 
  geom_sf(data=PA_county_2010,aes(fill = meanPOV),alpha=0.3) + 
  scale_fill_gradient2(low="blue",high="red", midpoint = .15) +
   labs(fill = "% Pop in Poverty")+
  geom_sf(data=sf_PA_Lead_avg2010, aes(size=meanPb))+
   labs(size="Lead Values
       (/mug/m3)")+
  
```



```{r spatial analysis 2010, echo=FALSE, fig.cap="2010 Mean Lead Levels Across Pennsylvania",fig.align='left',fig.height = 8, fig.width = 10}
ggplot() + 
  geom_sf(data=PA_county_2010,aes(fill = meanPCI),alpha=0.3) + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 28000, breaks=c(16000,28000, 40000)) + 
  labs(fill = "Per Capita 
    Income")+
  geom_sf(data=sf_PA_Lead_avg2010, aes(size=meanPb))+
   labs(size="Lead Values
       (/mug/m3)")+
  
```

```{r spatial-analysis 2010, echo=FALSE, fig.cap="2010 Max Lead Levels over .15 (µg/m3)",fig.align='left',fig.height = 8, fig.width = 10}

ggplot() + 
  geom_sf(data=PA_county_2010,aes(fill = meanPCI),alpha=0.3) + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 28000, breaks=c(16000,28000, 40000)) +
  labs(fill="Per Capita 
    Income")+
  geom_sf(data=sf_PA_Lead_high_2010, aes(size=maxPb))+
   labs(size="Lead Values
       (µg/m3)")+
  


```


```{r spatial analysis 2015, echo=FALSE, fig.cap="2015 Mean Lead Levels Across Pennsylvania", fig.align='left',fig.height = 8, fig.width = 10}
#Reduce our data to just one record for each location, computing mean and max daily values 
EPAair_PA_Lead_avg2015 <- epa.PAlead.2015 %>%
  group_by(COUNTY, SITE_LATITUDE, SITE_LONGITUDE) %>%
  summarize(meanPb = mean(Daily.Mean.Pb.Concentration),
            maxPb = max(Daily.Mean.Pb.Concentration))

#Convert the dataset to a spatially enabled "sf" data frame
sf_PA_Lead_avg2015 <- st_as_sf(EPAair_PA_Lead_avg2015,
                             coords = c('SITE_LONGITUDE','SITE_LATITUDE'),
                             crs=4326)

sf_PA_Lead_high_2015<-filter(sf_PA_Lead_avg2015, maxPb > 0.15)
range(sf_PA_Lead_high_2010$meanPb)

#read in CDC Data for each year and group by county
#2015
CDC_PA_2014<-read.csv("./Data/Raw/Pennsylvania_CDC_2014.csv", header = TRUE)

CDC_PA_2014$CNTY_FIPS<-as.numeric(CDC_PA_2014$CNTY_FIPS)

CDC_PA_2014_avg<-CDC_PA_2014%>%
  group_by(COUNTY) %>%
  summarize(meanPCI = mean(E_PCI),
            meanPOV = mean(EP_POV),
            meanPOP = sum(E_TOTPOP))

CDC_PA_2014_avg<-mutate(CDC_PA_2014_avg, meanPOV = (meanPOV/100))
CDC_PA_2014_avg$CNTY_FIPS<-CDC_PA_2010_avg$CNTY_FIPS
#join CDC data and county shape file
PA_county_2014<-left_join(counties_sf, CDC_PA_2014_avg, by = c("CNTY_FIPS"))

ggplot() + 
  geom_sf(data=PA_county_2014,aes(fill = meanPOV),alpha=0.3) + 
   scale_fill_gradient2(low="blue",high="red", midpoint = .15) +
   labs(fill = "% Pop in Poverty")+
  geom_sf(data=sf_PA_Lead_avg2015, aes(size=meanPb))+
  labs(size="Lead Values 
       (µg/m3)")+
  
```


```{r spatial analysis 2015, echo=FALSE, fig.cap="2015 Mean Lead Levels Across Pennsylvania"}
ggplot() + 
  geom_sf(data=PA_county_2014,aes(fill = meanPCI),alpha=0.3) + 
   scale_fill_gradient2(low="red",high="blue", midpoint = 30000, breaks=c(18000,30000, 40000)) +
  labs(fill = "Per Capita
  Income")+
  geom_sf(data=sf_PA_Lead_avg2015, aes(size=meanPb))+
  labs(size="Lead Values
       (µg/m3)")+
  
```


```{r spatial analysis 2015, echo=FALSE, fig.cap="2015 Max Lead Levels over .15 (µg/m3)"}
ggplot() + 
  geom_sf(data=PA_county_2014,aes(fill = meanPCI),alpha=0.3) + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 30000, breaks=c(18000,30000, 40000)) +
  labs(fill="Per Capita
  Income")+
  geom_sf(data=sf_PA_Lead_high_2015, aes(size=maxPb))+
   labs(size="Lead Values
       (µg/m3)")+
  ggtitle("2015 Max Lead Levels over .15 (µg/m3)")
```

```{r spatial analysis 2020, echo=FALSE,fig.cap="2020 Mean Lead Levels Across Pennsylvania", fig.align='left',fig.height = 8, fig.width = 10}
#Reduce our data to just one record for each location, computing mean and max daily values 
EPAair_PA_Lead_avg2020 <- epa.PAlead.2020 %>%
  group_by(COUNTY, SITE_LATITUDE, SITE_LONGITUDE) %>%
  summarize(meanPb = mean(Daily.Mean.Pb.Concentration),
            maxPb = max(Daily.Mean.Pb.Concentration))

#Convert the dataset to a spatially enabled "sf" data frame
sf_PA_Lead_avg2020 <- st_as_sf(EPAair_PA_Lead_avg2020,
                             coords = c('SITE_LONGITUDE','SITE_LATITUDE'),
                             crs=4326)

sf_PA_Lead_high_2020<-filter(sf_PA_Lead_avg2020, maxPb > 0.15)

#read in CDC Data for each year and group by county
#2020
CDC_PA_2018<-read.csv("./Data/Raw/Pennsylvania_CDC_2018.csv", header = TRUE)

CDC_PA_2018$CNTY_FIPS<-as.numeric(CDC_PA_2018$CNTY_FIPS)

CDC_PA_2018_avg<-CDC_PA_2018%>%
  group_by(COUNTY) %>%
  summarize(meanPCI = mean(E_PCI),
            meanPOV = mean(EP_POV),
            meanPOP = sum(E_TOTPOP))

CDC_PA_2018_avg<-mutate(CDC_PA_2018_avg, meanPOV = (meanPOV/100))
CDC_PA_2018_avg$CNTY_FIPS<-CDC_PA_2010_avg$CNTY_FIPS
#join CDC data and county shape file
PA_county_2018<-left_join(counties_sf, CDC_PA_2018_avg, by = c("CNTY_FIPS"))

ggplot() + 
  geom_sf(data=PA_county_2018,aes(fill = meanPOV),alpha=0.3) + 
   scale_fill_gradient2(low="blue",high="red", midpoint = .15) +
   labs(fill = "% Pop in Poverty")+
  geom_sf(data=sf_PA_Lead_avg2020, aes(size=meanPb))+
  labs(size="Lead Values 
       (µg/m3)")+
  
```


```{r spatial analysis 2020, echo=FALSE, fig.cap="2020 Mean Lead Levels Across Pennsylvania", fig.align='left',fig.height = 8, fig.width = 10}
ggplot() + 
  geom_sf(data=PA_county_2018,aes(fill = meanPCI),alpha=0.3) + 
   scale_fill_gradient2(low="red",high="blue", midpoint = 35000, breaks=c(21000,35000, 47000)) +
  labs(fill = "Per Capita
  Income")+
  geom_sf(data=sf_PA_Lead_avg2020, aes(size=meanPb))+
  labs(size="Lead Values
       (µg/m3)")+
  
```


```{r spatial analysis 2020, echo=FALSE, fig.cap="2020 Max Lead Levels over .15 (µg/m3)",fig.align='left',fig.height = 8, fig.width = 10}
ggplot() + 
  geom_sf(data=PA_county_2018,aes(fill = meanPCI),alpha=0.3) + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 35000, breaks=c(21000,35000, 47000)) +
  labs(fill="Per Capita
  Income")+
  geom_sf(data=sf_PA_Lead_high_2020, aes(size=maxPb))+
   labs(size="Lead Values
       (µg/m3)")+
  


```

## Question 3: Is lead exposure (measured via blood lead levels) in children in Pennsylvania associated with air lead emission sources?
### Original Model (Model 4)
#### Blood lead = (\beta1 x metal) + (\beta2 x incinerators) + (\beta3 x airports) + (\beta4 x meanPerCapIncome) + (\beta5 x POV)

### Final Model (Model 9) 
#### Blood lead = (\beta1 x log_metal) + (\beta2 x log_incinerate) + (\beta4 x meanPerCapIncome) + (\beta5 x POV^2)

This model is statistically insignificant overall, with an f-statistic’s p-value (0.29) being far greater than 0.05. The coefficient of meanPCI (mean per-capita income) was statistically significant (p < 0.05), and can be interpreted as every decrease in income by $2,877 is correlated with a 1% increase in blood-lead levels in children. 

The low significance of this model is not surprising, given the limitations of the data. The number of metal/incinerator plants may not necessarily reflect the quantity of particulate lead being emitted, which likely varies greatly between plants. If data were able to be obtained about how much smoke/lead-particulate matter is being emitted per plant, then that would have been more useful. The same applies to airports; it is likely that the quantity of airports does not matter so much as the number of flights and size of planes cycling through each airport; were FAA data on these parameters available, they would have been carried out. This is ultimately why the airport data was omitted from the final model.

Quantity of plants/airports would have been more useful if the geographic units used in this model were smaller -- county-level data was the smallest data we could work with, given the reported blood lead levels reported by the CDC were at a county level. Another geographical consideration is that lead-emissions from the studied sources may not affect their respective counties and instead disperse to other counties. 

Of further concern with the metal processing data was that the range of metal-processing plants was low across counties (max number of plants was 12, min 0), with the mean being 1.72 plants/county. Such skewness of the mean may not be appropriate for an OLS regression.

```{r Regression Data Wrangling,include=FALSE}
#
epa.PAcounty.Pb2 <- epa.PA.airPb.processed %>%    #ADDED BY MAX FOR REGRESSION STUFF 
   select(Date,COUNTY, Daily.Mean.Pb.Concentration, COUNTY_CODE) %>%
                  group_by(COUNTY_CODE) %>%
  summarise(County.Mean.Pb=mean(Daily.Mean.Pb.Concentration))%>%
                  arrange(desc(County.Mean.Pb))

###2010 Census #####
census_sf <- st_read('./Data/Raw/CensusData/tl_2020_42_county10/tl_2020_42_county10.shp')
mapview(census_sf)
census_sf$FIPS <- census_sf$STATEFP10

###Metal####
#need to use R spatial analysis to determine which county FIPS each metal processing plant is in 
metal_sf <- st_read('./Data/Raw/Metal_processing/PA_DEP/Industrial_Mineral_Mining_Operations_(IMMO)_-_Mineral_Preparation_Plant/Industrial_Mineral_Mining_Operations_(IMMO)_-_Mineral_Preparation_Plant.shp')
metal_csv <- read.csv("./Data/Raw/Metal_processing/PA_DEP/Industrial_Mineral_Mining_Operations_(IMMO)_-_Mineral_Preparation_Plant.csv")

census_sf <- st_read('./Data/Raw/CensusData/tl_2020_42_county10/tl_2020_42_county10.shp')
mapview(census_sf)
census_sf$FIPS <- census_sf$STATEFP10
st_crs(census_sf)$epsg
metal_data_sf <- st_as_sf(metal_csv, coords = c('X', 'Y'), crs = 4269)
metal_4269 <- st_transform(metal_sf, crs = 4269)

class(metal_4269)
metal_join <- st_join(metal_4269, census_sf, join = st_intersects)
metal_join
class(metal_join$COUNTYFP10)
metal_join$COUNTYFP10

metal_summary <- metal_join %>% 
  filter(SITE_STATU == "ACTIVE") %>% 
  select(COUNTYFP10) %>% 
  count(COUNTYFP10) %>% 
  mutate(number_metal_plants = n) %>% 
  mutate(COUNTYFP10 = sub("^0+", "", COUNTYFP10)) %>% #get rid of trailing zeros 
  select(COUNTYFP10, number_metal_plants, geometry)
census_sf2 <- census_sf %>% 
  select(COUNTYFP10, NAME10)

metal_join_census <- st_join(census_sf2, metal_summary)  ## geographic joining 
metal_join_census[is.na(metal_join_census)] = 0  #remove NAs 
metal_join_census <- metal_join_census %>% 
  select(COUNTYFP10.x, NAME10, n, geometry) 

metal_join_census$dummy_metal <- as.numeric(metal_join_census$n > 0)



#####airport#####
airport_raw <- read.csv("./Data/Raw/Airport Data/Airports.csv",  stringsAsFactors = TRUE)
airport_sf <- st_as_sf(airport_raw, coords = c('X', 'Y'), crs = 4269)
airport_PA <- airport_sf %>% 
  filter(STATE == "PA") %>% 
  filter(TYPE_CODE == "AD") %>% 
  filter(PRIVATEUSE == 0)
mapview(airport_PA)

airport_PA2_subset <- airport_PA %>% 
  select(NAME, geometry)

airport_join <- st_join(airport_PA2_subset, census_sf, join = st_intersects)
class(airport_join$COUNTYFP10)
airport_summary <- airport_join %>% 
  select(COUNTYFP10) %>% 
  count(COUNTYFP10) %>% 
  mutate(number_airports = n) %>% 
  mutate(COUNTYFP10 = sub("^0+", "", COUNTYFP10)) %>% 
  select(COUNTYFP10, number_airports, geometry)



census_sf2 <- census_sf %>% 
  select(COUNTYFP10, NAME10)
airport_join_census <- st_join(census_sf2, airport_summary)
airport_join_census$number_airports <- airport_join_census$n



metal_join_census_airport <- st_join(metal_join_census, airport_PA)




joint_nonSF <- metal_join_census %>% 
  select(COUNTYFP10.x, NAME10, n)
joint_nonSF <- joint_nonSF %>% st_drop_geometry()
joint_nonSF$COUNTYFP10 <- joint_nonSF$COUNTYFP10.x
class(joint_nonSF)

#####Incinerators #####
incinerate_sf_raw <- st_read('./Data/Raw/Incinerator_Shp_Data/Air_Emission_Plant_-_Incinerator.shp')
incinerate_sf <- st_transform(incinerate_sf_raw, crs = 4269)
st_crs(incinerate_sf)$epsg 
st_crs(census_sf2)$epsg 
incinerate_sf2 <- incinerate_sf %>% 
  select( SITE_NAME, SITE_STATU, geometry, SUB_FACILI) %>% 
  filter(SITE_STATU == "ACTIVE") %>% 
  filter(SUB_FACILI == "INCINERATOR" ) %>% 
incinerate_join_census<- st_join(incinerate_sf, census_sf2, join = st_intersects) # join 
incinerate_join_census[is.na(incinerate_join_census)] = 0  #remove NAs 
incinerate_join_census <- metal_join_census %>%  #clean data 
  select(COUNTYFP10.x, NAME10, n, geometry) 

incinerator_summary <- incinerate_join_census %>% 
  select(COUNTYFP10) %>% 
  count(COUNTYFP10) %>% 
  mutate(number_incinerators = n) %>% #rename count column
  mutate(COUNTYFP10 = sub("^0+", "", COUNTYFP10)) %>% #get rid of trailing zeros 
  select(COUNTYFP10, number_incinerators, geometry) #clean

incinerator_summary[is.na(incinerator_summary)] = 0  #remove NAs 


###Blood_Lead_Children####
##contains county FIPS code
children_blood_lead <- read.csv("./Data/Raw/BloodLeadLevels/PA_CountyLevelSummary_2017.csv", stringsAsFactors = TRUE)
children_blood_lead$COUNTYFP10<- as.character(children_blood_lead$County.FIPS)
class(children_blood_lead$COUNTYFP10)
print(children_blood_lead$COUNTYFP10)

children_blood_lead$Percent_.5 <- as.numeric(children_blood_lead$Percent_.5)
blood_lead <- children_blood_lead %>% 
  select(COUNTYFP10, County.Name, Percent_.5)


joint_nonSF$COUNTYFP10 <- sub("^0+", "", joint_nonSF$COUNTYFP10) #get rid of trailing 0's 
print(joint_nonSF$COUNTYFP10)
joint_nonSF2 <- left_join(joint_nonSF, blood_lead)
#### Joining Data ####
blood_lead #non-sf; join below three and then drop geometry, then join all. 
incinerator_summary #sf
airport_summary #sf
metal_summary #sf 
CDC_PA_2010_avg2 <- CDC_PA_2010_avg %>% 
  select(CNTY_FIPS, meanPCI, meanPOV) %>% 
  mutate(COUNTYFP10 = CNTY_FIPS) %>% 
  select(COUNTYFP10, meanPCI, meanPOV)
CDC_PA_2010_avg2$COUNTYFP10 <- as.character(CDC_PA_2010_avg2$COUNTYFP10)

class(CDC_PA_2010_avg2$COUNTYFP10)
class(i_a_m_b_join$COUNTYFP10)
incinerator_summary2 <- incinerator_summary %>% st_drop_geometry()
airport_summary2 <- airport_summary %>% st_drop_geometry()
metal_summary2 <- metal_summary %>% st_drop_geometry()  


i_a_join<- left_join(incinerator_summary2, airport_summary2)
i_a_m_join <- left_join(i_a_join, metal_summary2)
i_a_m_b_join <- left_join(i_a_m_join, blood_lead)   # join of all datasets USE IN REGRESSION 
i_a_m_b_join <- left_join(i_a_m_b_join, CDC_PA_2010_avg2)
i_a_m_b_join[is.na(i_a_m_b_join)] = 0  #remove NAs 

```

```{r setuping section, echo = FALSE, message = FALSE, warning = FALSE, fig.cap = "Histograms of Emission Sites" }
### Data Visualization ####
library(ggplot2)
p1<-ggplot(i_a_m_b_join, aes(x=number_incinerators))+
  geom_histogram(fill="lightgreen", color="darkgreen", binwidth=1)+
  labs(x="# of Incinerators", title="Incinerators per county, histogram")
p2<-ggplot(i_a_m_b_join, aes(x=number_airports))+
  geom_histogram(fill="lightgreen", color="darkgreen", binwidth=1)+
  labs(x="# of airports", title="Airports per county, histogram")
p3<-ggplot(i_a_m_b_join, aes(x=number_metal_plants))+
  geom_histogram(fill="lightgreen", color="darkgreen", binwidth=1)+
  labs(x="# of metal plants", title="Processing plants per county, histogram")
p1
p2
p3
```

```{r sum stats1, echo = FALSE, message = FALSE, warning = FALSE, fig.cap = "Summary Statistics of Metal", fig.align='left',fig.height = 8, fig.width = 10}
#summary stats tables
summary.metal <- i_a_m_b_join %>% 
  select(number_metal_plants) %>% 
  dplyr::summarize(Length=length(number_metal_plants),
                   Mean=mean(number_metal_plants),
                   Median=median(number_metal_plants),
                   Std_Dev=sd(number_metal_plants),
                   Minimum=min(number_metal_plants),
                   Maximum=max(number_metal_plants)
                   ) 
glimpse(summary.metal)
```
```{r sum stats2, echo = FALSE, message = FALSE, warning = FALSE, fig.cap = "Summary Statistics of Incinerators" }
summary.incinerate <- i_a_m_b_join %>% 
  select(number_incinerators) %>% 
  dplyr::summarize(Length=length(number_incinerators),
                   Mean=mean(number_incinerators),
                   Median=median(number_incinerators),
                   Std_Dev=sd(number_incinerators),
                   Minimum=min(number_incinerators),
                   Maximum=max(number_incinerators)
                   ) 
glimpse(summary.incinerate)
```

```{r sum stats3, echo = FALSE, message = FALSE, warning = FALSE, fig.cap = "Summary Statistics of Airports",fig.height = 8, fig.width = 10, fig.align='left'}
summary.airport <- i_a_m_b_join %>% 
  select(number_airports) %>% 
  dplyr::summarize(Length=length(number_airports),
                   Mean=mean(number_airports),
                   Median=median(number_airports),
                   Std_Dev=sd(number_airports),
                   Minimum=min(number_airports),
                   Maximum=max(number_airports)
                   ) 
glimpse(summary.airport)
```
```{r plots, echo = FALSE, message = FALSE, warning = FALSE, fig.cap = "Linear Plots of Individual Variables"  }
#### Linear Plots ####

ggplot(i_a_m_b_join, aes(log_metal, Percent_.5)) +
  geom_point() + 
  stat_smooth(method = lm, se = FALSE)

ggplot(i_a_m_b_join, aes(log_incinerate, Percent_.5)) +
  geom_point() +
  stat_smooth(method = lm, se = FALSE)

ggplot(i_a_m_b_join, aes(meanPCI    , Percent_.5)) +
  geom_point() +
  stat_smooth(method = lm, se = FALSE)

ggplot(i_a_m_b_join, aes(quadPOV, Percent_.5)) +
  geom_point() +
  stat_smooth(method = lm, se = FALSE)

ggplot(i_a_m_b_join, aes(number_airports, Percent_.5)) +
  geom_point() +
  stat_smooth(method = lm, se = FALSE)
```

```{r transformations, include = FALSE}
#### Transformations ##### 
i_a_m_b_join$number_incinerators <-i_a_m_b_join$number_incinerators+0.001 #account for zeros in log
i_a_m_b_join$number_airports <- i_a_m_b_join$number_airports+0.001 #account for zeros in log
i_a_m_b_join$number_metal_plants <- i_a_m_b_join$number_metal_plants+1 #account for zeros in log

plot(x = i_a_m_b_join$number_metal_plants, y = i_a_m_b_join$Percent_.5) # consider logging
plot(x = i_a_m_b_join$number_incinerators, y = i_a_m_b_join$Percent_.5) # consider logging 
plot(x = i_a_m_b_join$number_airports, y = i_a_m_b_join$Percent_.5)
plot(x = i_a_m_b_join$meanPCI, y = i_a_m_b_join$Percent_.5)
plot(x = i_a_m_b_join$meanPOV, y = i_a_m_b_join$Percent_.5)

i_a_m_b_join$log_metal <- log(i_a_m_b_join$number_metal_plants) #log transform X
i_a_m_b_join$log_incinerate <- log(i_a_m_b_join$number_incinerators) #log transform X
i_a_m_b_join$log_blood <- log(i_a_m_b_join$Percent_.5) #log transform Y 
i_a_m_b_join$log_PCI <- log(i_a_m_b_join$meanPCI)#log transform X
i_a_m_b_join$quadPOV <- (i_a_m_b_join$meanPOV)^2# quadratic X 

plot(x = i_a_m_b_join$log_metal, y = i_a_m_b_join$Percent_.5) #log metal; looks better 
plot(x = i_a_m_b_join$log_incinerate, y = i_a_m_b_join$Percent_.5) #log incinerator ; looks better
plot(x = i_a_m_b_join$number_airports, y = i_a_m_b_join$log_blood) 
plot(x = i_a_m_b_join$log_PCI, y = i_a_m_b_join$Percent_.5)
plot(x = i_a_m_b_join$quadPOV, y = i_a_m_b_join$Percent_.5)
```


```{r modeling, include = FALSE}
model1 <- lm(formula = Percent_.5 ~ number_metal_plants + number_incinerators + number_airports, data = i_a_m_b_join)
summary(model1)

model2 <- lm(formula = Percent_.5 ~ log_metal + log_incinerate + number_airports, data = i_a_m_b_join)
summary(model2)

model3 <- lm(formula = log_blood ~ number_metal_plants + number_incinerators + number_airports, data = i_a_m_b_join)
summary(model3)
#additional variables
model4 <- lm(formula = Percent_.5 ~ number_metal_plants + number_incinerators + number_airports + meanPCI + meanPOV, data = i_a_m_b_join)
summary(model4) #use this code !

model5 <- lm(formula = Percent_.5 ~ number_metal_plants + number_incinerators + number_airports + log_PCI + quadPOV, data = i_a_m_b_join)
summary(model5)
plot(model5)

model6 <- lm(formula = Percent_.5 ~ number_metal_plants + log_metal+ log_incinerate + meanPCI +    number_incinerators + number_airports + log_PCI + quadPOV, data = i_a_m_b_join) # plugged in every variable and then ran through "step" function , which produced model 7 
summary(model6)
step(model6) 

model7 <- lm(formula = Percent_.5 ~ meanPOV+ quadPOV, data = i_a_m_b_join)
summary(model7)

model8 <- lm(formula = Percent_.5 ~ log_metal + log_incinerate + number_airports + meanPCI + quadPOV, data = i_a_m_b_join)
summary(model8)

model9 <- lm(formula = Percent_.5 ~ log_metal + log_incinerate + meanPCI + quadPOV, data = i_a_m_b_join)
summary(model9) # final model 
```

```{r analysis tools, include = FALSE}
### Regression Visualization #####
par(mfrow=c(2,2), mar = c(2,2,2,2))

plot(model4)
```

```{r analysis tools2, echo = FALSE, message = FALSE, warning = FALSE, fig.cap = "Model Assumption Plots"  }
plot(model9)

```

```{r setup, include = FALSE}
par(mfrow=c(2,2), mar = c(2,2,2,2))
#Individual Scatters to test for linearity 
plot(x = i_a_m_b_join$log_metal, y = i_a_m_b_join$Percent_.5) #log metal; looks better 
plot(x = i_a_m_b_join$log_incinerate, y = i_a_m_b_join$Percent_.5) 
plot(x = i_a_m_b_join$log_PCI, y = i_a_m_b_join$Percent_.5)
plot(x = i_a_m_b_join$quadPOV, y = i_a_m_b_join$Percent_.5)
plot(x = i_a_m_b_join$number_airports, y = i_a_m_b_join$Percent_.5)

ggplot(i_a_m_b_join, aes(log_metal, Percent_.5)) +
  geom_point() + 
  stat_smooth(method = lm, se = FALSE)

ggplot(i_a_m_b_join, aes(log_incinerate, Percent_.5)) +
  geom_point() +
  stat_smooth(method = lm, se = FALSE)

ggplot(i_a_m_b_join, aes(meanPCI    , Percent_.5)) +
  geom_point() +
  stat_smooth(method = lm, se = FALSE)

ggplot(i_a_m_b_join, aes(quadPOV, Percent_.5)) +
  geom_point() +
  stat_smooth(method = lm, se = FALSE)

ggplot(i_a_m_b_join, aes(number_airports, Percent_.5)) +
  geom_point() +
  stat_smooth(method = lm, se = FALSE)
```

```{r analyis final, echo = FALSE, message = FALSE, warning = FALSE, fig.cap = "Model Assumption Plots",fig.align='left',fig.height = 8, fig.width = 10}
#homoskedasticity and normality 
par(mfrow=c(2,2), mar = c(2,2,2,2))
#plot(model4)
plot(model9)
#summary(model4)
```

```{r Summary final, echo = FALSE, message = FALSE, warning = FALSE, fig.cap = "Final Model Summary", fig.height = 8, fig.width = 10, fig.align='left'}
summary(model9)
#AIC(model4)
AIC(model9)
#Multicolinearity 
library(car)
```
```{r multicollinearity, echo = FALSE, message = FALSE, warning = FALSE, fig.cap = "Multicollinearity Test - VIF Test"  }
vif(model9)
vif(model4)

```
\newpage
# Summary and Conclusions

We found that four of the five most populous metropolitan areas Philadelphia-Camden-Wilmington, PA-NJ-DE-MD (2010-2020), Pittsburgh, PA (2010-2020), Allentown-Bethlehem-Easton, PA-NJ (2012-2020), and Scranton--Wilkes-Barre--Hazleton, PA (2010-2018) in Pennsylvania had downward monotonic trends for daily and monthly mean air lead concentrations (p<0.05). The Lancaster, PA metropolitan area did not show a monotonic downward trend for air lead levels, which may be attributed to other factors not explored in this study such as industrial emissions between 2012 and 2020. It is important to note that the downward trend for the other four metropolitan areas may be attributed to the banning of lead in paints in 1978, the banning of lead in vehicle fuels in 1996, the waning of lead-smelting industry, or other factors such as lead abatement programs from 2010 to 2020  in Pennsylvania into the twenty-first century (Schwarz et al., 2012). Future studies may look at conducting multiple linear regression to assess air lead levels in association with remediation measures to reduce air lead exposure or other factors such as climate factors like temperature and wind speed, which may influence quantity of lead in ambient air (Kinney, 2018). Obtaining census-block specific data and air emissions data will enable stronger multilinear regression in future models. 

\newpage
# References
Ab Latif Wani, A. A., & Usmani, J. A. (2015). Lead toxicity: a review. Interdisciplinary toxicology, 8(2), 55. doi: 10.1515/intox-2015-0009

About Air Data Reports. (2021). United States Environmental Protection Agency. Retrieved from https://www.epa.gov/outdoor-air-quality-data/about-air-data-reports 

American Lung Association (2021). Most Polluted Cities. Retrieved from https://www.lung.org/research/sota/city-rankings/most-polluted-cities 

CDC Social Vulnerability Index Data [internet database] available via https://www.atsdr.cdc.gov/placeandhealth/svi/data_documentation_download.html

Kinney, P. L. (2018). Interactions of climate change, air pollution, and human health. Current environmental health reports, 5(1), 179-186.https://doi.org/10.1007/s40572-018-0188-x

O’Shea, M. J., Vann, D. R., Hwang, W. T., & Gieré, R. (2020). A mineralogical and chemical investigation of road dust in Philadelphia, PA, USA. Environmental Science and Pollution Research, 1-20. https://doi.org/10.1007/s11356-019-06746-y

PA Department of Health (2014). 2014 Childhood Lead Surveillance Annual Report. Retrieved from https://www.health.pa.gov/topics/Documents/Environmental%20Health/2014%20Lead%20Surveillance%20Annual%20Report.pdf 

Pizzol, M., Thomsen, M., & Andersen, M. S. (2010). Long-term human exposure to lead from different media and intake pathways. Science of the total environment, 408(22), 5478-5488. https://doi.org/10.1016/j.scitotenv.2010.07.077  

Schwarz, K., Pickett, S. T., Lathrop, R. G., Weathers, K. C., Pouyat, R. V., & Cadenasso, M. L. (2012). The effects of the urban built environment on the spatial distribution of lead in residential soils. Environmental pollution, 163, 32-39. https://doi.org/10.1016/j.envpol.2011.12.003 

Stevens, S. K. (1955). A Century of Industry in Pennsylvania. Pennsylvania History: A Journal of Mid-Atlantic Studies, 22(1), 49-68. 

United Health Foundation. (2019). America’s Health Rankings. Retrieved from https://assets.americashealthrankings.org/app/uploads/ahr_2019annualreport.pdf 

US Census Bureau. (2019). Metropolitan and Micropolitan Statistical Area Population Estimates and Estimated Components of Change: April 1, 2010 to July 1, 2019 (CBSA-EST2019-alldata). Retrieved from https://www.census.gov/data/tables/time-series/demo/popest/2010s-total-metro-and-micro-statistical-areas.html#par_textimage 

US Census Bureau. (2020a). CBSA-EST2019-alldata: Annual Resident Population Estimates and Estimated Components of Resident Population Change for Metropolitan and Micropolitan Statistical Areas and Their Geographic Components: April 1, 2010 to July 1, 2019 
https://www2.census.gov/programs-surveys/popest/technical-documentation/file-layouts/2010-2019/cbsa-est2019-alldata.pdf 

US Census Bureau (2020b). METHODOLOGY FOR THE UNITED STATES POPULATION ESTIMATES: VINTAGE 2019 Nation, States, Counties, and Puerto Rico – April 1, 2010 to July 1, 2019. Retrieved from https://www2.census.gov/programs-surveys/popest/technical-documentation/methodology/2010-2019/natstcopr-methv2.pdf 

US Environmental Protection Agency. Air Quality System Data Mart [internet database] available via https://www.epa.gov/airdata. Accessed April 05, 2021.

US EPA. (2021a). Basic Information about Lead Air Pollution. Lead Air Pollution. Retrieved from https://www.epa.gov/lead-air-pollution/basic-information-about-lead-air-pollution#:~:text=At%20the%20national%20level%2C%20major,usually%20found%20near%20lead%20smelters. 

US EPA. (2021b). Timeline of Lead (Pb) National Ambient Air Quality Standards (NAAQS)
Retrieved from https://www.epa.gov/lead-air-pollution/timeline-lead-pb-national-ambient-air-quality-standards-naaqs 
WHO. (2021). Lead poisoning and health. Retrieved April 24, 2021, from https://www.who.int/news-room/fact-sheets/detail/lead-poisoning-and-health
