---
output: 
  pdf_document:
    
    
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
geometry: margin=2.54cm
title: "Spatial and Temporal Evaluation of Lead Air Pollution Patterns in Pennsylvania"
subtitle: "https://github.com/nyb5208/Alcorn_Bao_Hermanson_ENV_872_EDA_FinalProject.git"
author: "Jack Alcorn, Max Hermanson, and Nancy Bao "
fontsize: 12pt
mainfont: Times New Roman
editor_options:
  chunk_output_type: console
---

\newpage
\tableofcontents 
\newpage
\listoftables 
\newpage
\listoffigures 
\newpage

```{r setup, include=FALSE}
# Set your working directory
getwd()
# Load your packages
library(tidyverse)
library(ggplot2)
library(ggridges)
library(ggpubr)
library(dplyr)
library(lubridate)
library(zoo)
library(trend)
library(sf)
library(knitr)
library(kableExtra)
#Load color palette packages
library(RColorBrewer)
library(wesanderson)
library(viridisLite)
library(viridis)
library(colormap)
library(mapview)
library(sf)
# Set your ggplot theme
project.theme <- theme_classic(base_size=12)+
                 theme(plot.title= 
                         element_text(size=14,
                         face="bold",
                         color= "black",
                         hjust=0.5),
                         axis.text = 
                         element_text(color = "black"),
                         axis.title = 
                         element_text(color= "black",face= "bold"),
                         legend.position="top")
theme_set(project.theme)
#___________________

# Load EPA Air Lead Pollution datasets
epa.PAlead.2010 <-read.csv( "./Data/Raw/EPA_Lead_PA/EPA_10_PA_lead.csv", stringsAsFactors = TRUE)
epa.PAlead.2011 <-read.csv( "./Data/Raw/EPA_Lead_PA/EPA_11_PA_lead.csv", stringsAsFactors = TRUE)
epa.PAlead.2012 <-read.csv( "./Data/Raw/EPA_Lead_PA/EPA_12_PA_lead.csv", stringsAsFactors = TRUE)
epa.PAlead.2013 <-read.csv( "./Data/Raw/EPA_Lead_PA/EPA_13_PA_lead.csv", stringsAsFactors = TRUE)
epa.PAlead.2014 <-read.csv( "./Data/Raw/EPA_Lead_PA/EPA_14_PA_lead.csv", stringsAsFactors = TRUE)
epa.PAlead.2015 <-read.csv( "./Data/Raw/EPA_Lead_PA/EPA_15_PA_lead.csv", stringsAsFactors = TRUE)
epa.PAlead.2016 <-read.csv( "./Data/Raw/EPA_Lead_PA/EPA_16_PA_lead.csv", stringsAsFactors = TRUE)
epa.PAlead.2017 <-read.csv( "./Data/Raw/EPA_Lead_PA/EPA_17_PA_lead.csv", stringsAsFactors = TRUE)
epa.PAlead.2018 <-read.csv( "./Data/Raw/EPA_Lead_PA/EPA_18_PA_lead.csv", stringsAsFactors = TRUE)
epa.PAlead.2019 <-read.csv( "./Data/Raw/EPA_Lead_PA/EPA_19_PA_lead.csv", stringsAsFactors = TRUE)
epa.PAlead.2020 <-read.csv( "./Data/Raw/EPA_Lead_PA/EPA_20_PA_lead.csv", stringsAsFactors = TRUE)
# Combined the EPA lead air data sets with rbind()
epa.PAair.lead <-rbind(epa.PAlead.2010, epa.PAlead.2011, epa.PAlead.2012, epa.PAlead.2013,
                       epa.PAlead.2014, epa.PAlead.2015, epa.PAlead.2016, epa.PAlead.2017,
                       epa.PAlead.2018, epa.PAlead.2019, epa.PAlead.2020)

#Change date variable from factor to date
epa.PAair.lead$Date <- as.Date(epa.PAair.lead$Date, format="%m/%d/%Y")
class(epa.PAair.lead$Date)
#___________________
#Load other datasets

#Read in PA Counties shp file (State FIPS = 42)
PA_county_sf <- st_read("./Data/Spatial/cb_2018_us_county_20m.shp") %>%
filter(STATEFP == 42)

```


# Rationale and Research Questions



\newpage

# Dataset Information
>US EPA Daily Outdoor Air Quality Data 


\newpage

# Exploratory Analysis 
```{r exploratory-analysis, include= FALSE, warning = FALSE}
#
dim(epa.PAair.lead)
colnames(epa.PAair.lead)
head(epa.PAair.lead)

#Cleaned and Processed EPA PA Air Lead Data
epa.PA.airPb.processed <- epa.PAair.lead %>%
                                  select(Date, Site.ID, 
                                         Daily.Mean.Pb.Concentration,
                                         Site.Name,AQS_PARAMETER_DESC,
                                         STATE,COUNTY, COUNTY_CODE) %>%
                                  mutate(Month = month(Date),
                                  Year=year(Date))

#Nancy, I added 'COUNTY_CODE' to the select() command above. I hope this doesn't mess anything up. **You're good**.
```


\newpage
# Introduction 
##### MAX 
# Analysis
```{r time_series-analysis}
#Create dataframe named all.Days using seq() and lubridate function ymd()
all.Days<-as.data.frame(seq(ymd("2010-01-01"), ymd("2020-12-31"),by="days"))
all.Days<-setNames(all.Days,c("Date"))
epa.PAcounty.Pb <- epa.PA.airPb.processed %>%
                  select(Date,COUNTY, Daily.Mean.Pb.Concentration) %>%
                  group_by(COUNTY) %>%
                  summarise(County.Mean.Pb=mean(Daily.Mean.Pb.Concentration))%>%
                  arrange(desc(County.Mean.Pb))
  
# Allegheny County
Allegheny_co_Pb <- epa.PA.airPb.processed %>%
                    filter(COUNTY=="Allegheny") %>%
                    select(Date,Daily.Mean.Pb.Concentration)
Allegheny_Pb <-left_join(all.Days,Allegheny_co_Pb)
# Beaver County
Beaver_co_Pb <- epa.PA.airPb.processed %>%
                    filter(COUNTY=="Beaver") %>%
                    select(Date,Daily.Mean.Pb.Concentration)
Beaver_Pb <-left_join(all.Days,Beaver_co_Pb)
# Berks County
Berks_co_Pb <- epa.PA.airPb.processed %>%
                    filter(COUNTY=="Berks") %>%
                    select(Date,Daily.Mean.Pb.Concentration)
Berks_Pb <-left_join(all.Days,Berks_co_Pb)
# Delaware County
Delaware_co_Pb <- epa.PA.airPb.processed %>%
                    filter(COUNTY=="Delaware") %>%
                    select(Date,Daily.Mean.Pb.Concentration)
Delaware_Pb <-left_join(all.Days,Delaware_co_Pb)
# Lancaster County
Lancaster_co_Pb <- epa.PA.airPb.processed %>%
                    filter(COUNTY=="Lancaster") %>%
                    select(Date,Daily.Mean.Pb.Concentration)
Lancaster_Pb <-left_join(all.Days,Lancaster_co_Pb)

# Philadelphia County
Philly_co_Pb <- epa.PA.airPb.processed %>%
                    filter(COUNTY=="Philadelphia") %>%
                    select(Date,Daily.Mean.Pb.Concentration)
Philly_Pb <-left_join(all.Days,Philly_co_Pb)
# 
summary(epa.PA.airPb.processed$COUNTY)
PA.lead.2010.2020<-left_join(all.Days,epa.PA.airPb.processed)
###################
# Allegheny Co. 
Allegheny_lineplot<-ggplot(Allegheny_Pb,aes(x = Date,
y = Daily.Mean.Pb.Concentration))+
geom_line(color = "black") +
labs(y="Daily Average Pb Concentration (ppm)",
title="Daily Average Pb Concentrations from 2010 to 2020 in Allegheny Co., PA")+
  scale_x_date(date_breaks = "6 months",date_labels = "%b %Y")+
theme(axis.text.x=element_text(angle=90, hjust=1))
print(Allegheny_lineplot)
#
# Beaver Co. 
Beaver_lineplot<-ggplot(Beaver_Pb,aes(x = Date,
y = Daily.Mean.Pb.Concentration))+
geom_line(color = "black") +
labs(y="Daily Average Pb Concentration (ppm)",
title="Daily Average Pb Concentrations from 2010 to 2020 in Beaver Co., PA")+
  scale_x_date(date_breaks = "6 months",date_labels = "%b %Y")+
theme(axis.text.x=element_text(angle=90, hjust=1))
print(Beaver_lineplot)
#
# Berks Co.
Berks_lineplot<-ggplot(Berks_Pb,aes(x = Date,
y = Daily.Mean.Pb.Concentration))+
geom_line(color = "black") +
labs(y="Daily Average Pb Concentration (ppm)",
title="Daily Average Pb Concentrations from 2010 to 2020 in Berk Co., PA")+
  scale_x_date(date_breaks = "6 months",date_labels = "%b %Y")+
theme(axis.text.x=element_text(angle=90, hjust=1))
print(Berks_lineplot)
#
# Delaware Co.
Delaware_lineplot<-ggplot(Delaware_Pb,aes(x = Date,
y = Daily.Mean.Pb.Concentration))+
geom_line(color = "black") +
labs(y="Daily Average Pb Concentration (ppm)",
title="Daily Average Pb Concentrations from 2010 to 2020 in Delaware Co., PA")+
  scale_x_date(date_breaks = "6 months",date_labels = "%b %Y")+
theme(axis.text.x=element_text(angle=90, hjust=1))
print(Delaware_lineplot)
#
# Philadelphia Co.
Philly_lineplot<-ggplot(Philly_Pb,aes(x = Date,
y = Daily.Mean.Pb.Concentration))+
geom_line(color = "black") +
labs(y="Daily Average Pb Concentration (ppm)",
title="Daily Average Pb Concentrations from 2010 to 2020 in Philadelphia Co., PA")+
  scale_x_date(date_breaks = "6 months",date_labels = "%b %Y")+
theme(axis.text.x=element_text(angle=90, hjust=1))
print(Philly_lineplot)
```


```{r Linear Interpolation Visuals}
#Looking at the top 5 PA counties for highest air Pb concentrations from 2010 to 2020
#
epa.PAcounty.Pb2014 <- epa.PA.airPb.processed %>%
                  filter(Year==2014) %>%
                  select(Date,COUNTY, Daily.Mean.Pb.Concentration) %>%
                  group_by(COUNTY) %>%
                  summarise(County.Mean.Pb=mean(Daily.Mean.Pb.Concentration))%>%
                  arrange(desc(County.Mean.Pb))
#
epa.PAcounty.Pb2015 <- epa.PA.airPb.processed %>%
                  filter(Year==2015) %>%
                  select(Date,COUNTY, Daily.Mean.Pb.Concentration) %>%
                  group_by(COUNTY) %>%
                  summarise(County.Mean.Pb=mean(Daily.Mean.Pb.Concentration))%>%
                  arrange(desc(County.Mean.Pb))
#
epa.PAcounty.Pb2016 <- epa.PA.airPb.processed %>%
                  filter(Year==2016) %>%
                  select(Date,COUNTY, Daily.Mean.Pb.Concentration) %>%
                  group_by(COUNTY) %>%
                  summarise(County.Mean.Pb=mean(Daily.Mean.Pb.Concentration))%>%
                  arrange(desc(County.Mean.Pb))           
#
epa.PAcounty.Pb2017 <- epa.PA.airPb.processed %>%
                  filter(Year==2017) %>%
                  select(Date,COUNTY, Daily.Mean.Pb.Concentration) %>%
                  group_by(COUNTY) %>%
                  summarise(County.Mean.Pb=mean(Daily.Mean.Pb.Concentration))%>%
                  arrange(desc(County.Mean.Pb))   
#
epa.PAcounty.Pb2018 <- epa.PA.airPb.processed %>%
                  filter(Year==2018) %>%
                  select(Date,COUNTY, Daily.Mean.Pb.Concentration) %>%
                  group_by(COUNTY) %>%
                  summarise(County.Mean.Pb=mean(Daily.Mean.Pb.Concentration))%>%
                  arrange(desc(County.Mean.Pb))      
#
epa.PAcounty.Pb2019 <- epa.PA.airPb.processed %>%
                  filter(Year==2019) %>%
                  select(Date,COUNTY, Daily.Mean.Pb.Concentration) %>%
                  group_by(COUNTY) %>%
                  summarise(County.Mean.Pb=mean(Daily.Mean.Pb.Concentration))%>%
                  arrange(desc(County.Mean.Pb))  
#
epa.PAcounty.Pb2020 <- epa.PA.airPb.processed %>%
                  filter(Year==2020) %>%
                  select(Date,COUNTY, Daily.Mean.Pb.Concentration) %>%
                  group_by(COUNTY) %>%
                  summarise(County.Mean.Pb=mean(Daily.Mean.Pb.Concentration))%>%
                  arrange(desc(County.Mean.Pb))      
#1.Carbon County
#2.Berks County
#3.Beaver County
#4.Lancaster County
#5.Philadelphia County
PA.airPB.filtered.Carbon <- epa.PA.airPb.processed %>%
                     filter(COUNTY=="Carbon") %>%
                     select(Date, Daily.Mean.Pb.Concentration)
time_days <-as.data.frame(seq(ymd("2012-07-01"), ymd("2020-09-30"),by="days"))
time_days <-setNames(time_days, c("Date"))
PA.airPb.Carbon <-left_join(time_days, PA.airPB.filtered.Carbon)

PA.airPb.clean.Carbon <- PA.airPb.Carbon %>%
                  mutate(Daily.Mean.Pb.Concentration=
                           zoo::na.approx(Daily.Mean.Pb.Concentration))
summary(PA.airPb.clean.Carbon$Daily.Mean.Pb.Concentration)

PA.county.airPb.Carbon <-ggplot(epa.PA.airPb.filtered.Carbon)+
                         geom_bar(aes(x=Date,
                             y=Daily.Mean.Pb.Concentration))+
  scale_x_date(date_breaks = "6 months",date_labels = "%b %Y")
print(PA.county.airPb.Carbon)
```




```{r spatial-analysis}
#Reduce our data to just one record for each location, computing mean and max daily AQI values 2010 and 2020
EPAair_PA_Lead_avg2010 <- epa.PAlead.2010 %>%
  group_by(COUNTY, SITE_LATITUDE, SITE_LONGITUDE) %>%
  summarize(meanPb = mean(Daily.Mean.Pb.Concentration),
            maxPb = max(Daily.Mean.Pb.Concentration))

EPAair_PA_Lead_avg2015 <- epa.PAlead.2015 %>%
  group_by(COUNTY, SITE_LATITUDE, SITE_LONGITUDE) %>%
  summarize(meanPb = mean(Daily.Mean.Pb.Concentration),
            maxPb = max(Daily.Mean.Pb.Concentration))

EPAair_PA_Lead_avg2020 <- epa.PAlead.2020 %>%
  group_by(COUNTY, SITE_LATITUDE, SITE_LONGITUDE) %>%
  summarize(meanPb = mean(Daily.Mean.Pb.Concentration),
            maxPb = max(Daily.Mean.Pb.Concentration))

#Convert the dataset to a spatially enabled "sf" data frame
sf_PA_Lead_avg2010 <- st_as_sf(EPAair_PA_Lead_avg2010,
                             coords = c('SITE_LONGITUDE','SITE_LATITUDE'),
                             crs=4326)

sf_PA_Lead_avg2015 <- st_as_sf(EPAair_PA_Lead_avg2015,
                             coords = c('SITE_LONGITUDE','SITE_LATITUDE'),
                             crs=4326)

sf_PA_Lead_avg2020 <- st_as_sf(EPAair_PA_Lead_avg2020,
                             coords = c('SITE_LONGITUDE','SITE_LATITUDE'),
                             crs=4326)

#Map sf datasets
PA_map_2010<-mapview(sf_PA_Lead_avg2010, 
        zcol='meanPb', 
        cex='maxPb')
PA_map_2010

PA_map_2015<-mapview(sf_PA_Lead_avg2015, 
        zcol='meanPb', 
        cex='maxPb')
PA_map_2015

PA_map_2020<-mapview(sf_PA_Lead_avg2020, 
        zcol='meanPb', 
        cex='maxPb')
PA_map_2020

```

```{r Regression}
#
epa.PAcounty.Pb2 <- epa.PA.airPb.processed %>%    #ADDED BY MAX FOR REGRESSION STUFF 
   select(Date,COUNTY, Daily.Mean.Pb.Concentration, COUNTY_CODE) %>%
                  group_by(COUNTY_CODE) %>%
  summarise(County.Mean.Pb=mean(Daily.Mean.Pb.Concentration))%>%
                  arrange(desc(County.Mean.Pb))
###Metal####
#need to use R spatial analysis to determine which county FIPS each metal processing plant is in 
metal_sf <- st_read('./Data/Raw/Metal_processing/PA_DEP/Industrial_Mineral_Mining_Operations_(IMMO)_-_Mineral_Preparation_Plant/Industrial_Mineral_Mining_Operations_(IMMO)_-_Mineral_Preparation_Plant.shp')
metal_csv <- read.csv("./Data/Raw/Metal_processing/PA_DEP/Industrial_Mineral_Mining_Operations_(IMMO)_-_Mineral_Preparation_Plant.csv", stringsAsFactors = TRUE)
#mapview(metal_sf)
metal_4269 <- st_transform(metal_sf, crs = 4269)

#metal_sf2 <- county_sf %>% 
  #filter(STATEFP == 31)

###Blood_Lead_Children####
##contains county FIPS code
children_blood_lead <- read.csv("./Data/Raw/BloodLeadLevels/PA_CountyLevelSummary_2017.csv", stringsAsFactors = TRUE)
children_blood_lead$FIPS<- children_blood_lead$PA.Blood.Lead.Levels..µg.dL..among.Children...72.Months.of.Age..by.County.and.Blood.Lead.Level..BLL..Group..2017
###2010 Census #####
census_sf <- st_read('./Data/Raw/CensusData/tl_2020_42_county10/tl_2020_42_county10.shp')
mapview(census_sf)
census_sf$FIPS <- census_sf$STATEFP10


#mapping intersections
newmap<- ggplot()+
  geom_sf(data = census_sf, color = "Black", fill = "Green", alpha = 0.3, show.legend = "polygon")+
  geom_sf(data = metal_sf, color = 'blue', size = 2, show.legend = "point" )
newmap

st_crs(census_sf)$epsg 
st_crs(metal_4269)$epsg


epa.PAcounty.Pb2$FIPS <- epa.PAcounty.Pb2$COUNTY_CODE
class(epa.PAcounty.Pb2$FIPS)
metal_intersection_withcounties$FIPS <- as.numeric(metal_intersection_withcounties$COUNTYFP10)
class(metal_intersection_withcounties$FIPS)


test_join <- right_join(epa.PAcounty.Pb2, metal_intersection_withcounties3, by = c("FIPS"))

metal_intersection_withcounties <- census_sf[metal_4269,]
metal_intersection_withcounties3 <- metal_4269[census_sf,]
mapview(metal_intersection_withcounties)
#mapview(metal_intersection_withcounties)
metal_intersection_withcounties2 <- census_sf %>% 
  filter(st_intersects(x = ., y = metal_4269, sparse = FALSE))

#airport
airport_raw <- read.csv("./Data/Raw/Airport Data/Airports.csv",  stringsAsFactors = TRUE)
airport_sf <- st_as_sf(airport_raw, coords = c('X', 'Y'), crs = 4269)
airport_PA <- airport_sf %>% 
  filter(STATE == "PA") %>% 
  filter(TYPE_CODE == "AD") %>% 
  filter(PRIVATEUSE == 0)
mapview(airport_PA)

#resp disease 

```
filter(!is.na(Latitude), !is.na(Longitude)) %>%

latlong_final <- latlong_sf %>%
  mutate(intersection = as.integer(intersected),
         fips = if_else(is.na(intersection), "",
                        census_tracts$GEOID[intersection]))
head(latlong_final)
## Question 1: How do air lead concentrations vary from 2010 to 2020 across Pennsylvania?

## Question 2: Where are the hotspots for air lead concentrations in Pennsylvania? 
#Jack

## Question 3: PA Income, resperitory disease, water lead levels, number of: airports, metal processing plants, coal plants, incinerators



\newpage

# Summary and Conclusions


\newpage

# References
<add references here if relevant, otherwise delete this section> 
